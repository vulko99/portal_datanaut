{% extends "portal/base_portal.html" %}

{% block title_suffix %} · Permissions{% endblock %}

{% block content %}
<div class="row g-3">

  <div class="col-12">
    <div class="portal-card">
      <div class="section-eyebrow mb-1">Access</div>
      <h1 class="section-title mb-1">Permissions</h1>
      <p class="section-subtitle mb-0">
        Assign users to services (per vendor). Changes reflect on User Detail.
      </p>

      <form method="get" class="mt-3">
        <div class="d-flex flex-wrap align-items-center gap-2">
          <div style="min-width: 240px;">
            <div class="metric-label mb-1">Vendor</div>
            <select name="vendor_id" class="form-select form-select-sm" onchange="this.form.submit()">
              <option value="">Select vendor…</option>
              {% for v in vendors %}
                <option value="{{ v.id }}" {% if selected_vendor and selected_vendor.id == v.id %}selected{% endif %}>
                  {{ v.name }}
                </option>
              {% endfor %}
            </select>
          </div>

          <div class="ms-auto d-flex flex-wrap align-items-center gap-3">
            <div class="form-check form-switch m-0">
              <input class="form-check-input" type="checkbox" id="scu" name="show_closed_users" value="1"
                     {% if show_closed_users %}checked{% endif %} onchange="this.form.submit()">
              <label class="form-check-label" for="scu">Show closed users</label>
            </div>
            <div class="form-check form-switch m-0">
              <input class="form-check-input" type="checkbox" id="scs" name="show_closed_services" value="1"
                     {% if show_closed_services %}checked{% endif %} onchange="this.form.submit()">
              <label class="form-check-label" for="scs">Show closed services</label>
            </div>
            <div class="form-check form-switch m-0">
              <input class="form-check-input" type="checkbox" id="scv" name="show_closed_vendors" value="1"
                     {% if show_closed_vendors %}checked{% endif %} onchange="this.form.submit()">
              <label class="form-check-label" for="scv">Show closed vendors</label>
            </div>
          </div>
        </div>
      </form>

      {% if selected_vendor %}
        <form method="post" class="mt-3" id="permForm">
          {% csrf_token %}
          <input type="hidden" name="vendor_id" value="{{ selected_vendor.id }}">
          <input type="hidden" name="action" id="permAction" value="assign">

          <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mt-2">
            <div class="d-flex flex-wrap gap-2 align-items-center">
              <span class="dn-pill">Vendor: <strong class="ms-1">{{ selected_vendor.name }}</strong></span>
              <span class="dn-pill">Selected users: <strong class="ms-1" id="selUsersCount">0</strong></span>
              <span class="dn-pill">Selected services: <strong class="ms-1" id="selServicesCount">0</strong></span>
            </div>

            {% if show_closed_users %}
  <input type="hidden" name="show_closed_users" value="1">
{% endif %}
{% if show_closed_services %}
  <input type="hidden" name="show_closed_services" value="1">
{% endif %}
{% if show_closed_vendors %}
  <input type="hidden" name="show_closed_vendors" value="1">
{% endif %}

            <div class="d-flex flex-wrap gap-2">
              <button type="submit" class="btn btn-add btn-sm" id="assignBtn" disabled>
                Assign
              </button>
              <button type="submit" class="btn btn-ghost btn-sm" id="unassignBtn" disabled>
                Unassign
              </button>
            </div>
          </div>

          <div class="row g-3 mt-2">
            <!-- LEFT: USERS -->
            <div class="col-lg-7">
              <div class="portal-card h-100">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
                  <div>
                    <h6 class="mb-1">Users</h6>
                    <div class="portal-card-muted small">Select users, then select services, then click Assign/Unassign.</div>
                  </div>

                  <div class="input-group input-group-sm" style="max-width: 320px;">
                    <span class="input-group-text">Search</span>
                    <input type="search" class="form-control" id="userSearch" placeholder="username, name, email…">
                  </div>
                </div>

                <div class="table-responsive">
                  <table class="portal-table align-middle" id="usersTable">
                    <thead>
                      <tr>
                        <th style="width: 70px;">
                          <div class="form-check m-0">
                            <input class="form-check-input" type="checkbox" id="selectAllUsers">
                          </div>
                        </th>
                        <th>User</th>
                        <th>Full name</th>
                        <th>Email</th>
                        <th>Status</th>
                        <th>Cost center</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for u in users %}
                        <tr
                          data-text="{{ u.username }} {{ u.email }} {{ u.first_name }} {{ u.last_name }} {{ u.profile.full_name|default_if_none:'' }}"
                        >
                          <td>
                            <div class="form-check m-0">
                              <input class="form-check-input user-cb"
                                     type="checkbox"
                                     name="user_ids"
                                     value="{{ u.id }}"
                                     id="u{{ u.id }}">
                            </div>
                          </td>
                          <td>
                            <a href="{% url 'portal:user_detail' u.id %}" class="link-table">{{ u.username }}</a>
                          </td>
                          <td class="cell-muted">{{ u.profile.full_name|default:"—" }}</td>
                          <td class="cell-muted">{{ u.email|default:"—" }}</td>
                          <td class="cell-muted">{% if u.is_active %}Active{% else %}Closed{% endif %}</td>
                          <td class="cell-muted">
                            {% if u.profile.cost_center %}
                              {{ u.profile.cost_center.code }}
                            {% else %}
                              —
                            {% endif %}
                          </td>
                        </tr>
                      {% empty %}
                        <tr><td colspan="6" class="cell-muted">No users.</td></tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>

              </div>
            </div>

            <!-- RIGHT: SERVICES -->
            <div class="col-lg-5">
              <div class="portal-card h-100">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
                  <div>
                    <h6 class="mb-1">Services for vendor</h6>
                    <div class="portal-card-muted small">Tick services (multiple). Then Assign/Unassign.</div>
                  </div>

                  <div class="input-group input-group-sm" style="max-width: 260px;">
                    <span class="input-group-text">Search</span>
                    <input type="search" class="form-control" id="serviceSearch" placeholder="service…">
                  </div>
                </div>

                <div class="table-responsive">
                  <table class="portal-table align-middle" id="servicesTable">
                    <thead>
                      <tr>
                        <th style="width:70px;">
                          <div class="form-check m-0">
                            <input class="form-check-input" type="checkbox" id="selectAllServices">
                          </div>
                        </th>
                        <th>Service</th>
                        <th style="width: 110px;">Status</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for s in services %}
                        <tr data-text="{{ s.name }} {{ s.category|default_if_none:'' }} {{ s.service_code|default_if_none:'' }}">
                          <td>
                            <div class="form-check m-0">
                              <input class="form-check-input service-cb"
                                     type="checkbox"
                                     name="service_ids"
                                     value="{{ s.id }}"
                                     id="s{{ s.id }}">
                            </div>
                          </td>
                          <td>
                            <label for="s{{ s.id }}" class="mb-0" style="cursor:pointer;">
                              <div class="fw-semibold">{{ s.name }}</div>
                              <div class="cell-muted small">
                                {{ s.get_category_display|default:s.category|default:"—" }}
                              </div>
                            </label>
                          </td>
                          <td class="cell-muted">{% if s.is_active %}Active{% else %}Closed{% endif %}</td>
                        </tr>
                      {% empty %}
                        <tr><td colspan="3" class="cell-muted">No services for this vendor.</td></tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>

              </div>
            </div>
          </div>
        </form>
      {% else %}
        <div class="empty mt-3">
          Select a vendor to start assigning users to services.
        </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
(function () {
  const form = document.getElementById("permForm");
  if (!form) return;

  const assignBtn = document.getElementById("assignBtn");
  const unassignBtn = document.getElementById("unassignBtn");
  const actionInput = document.getElementById("permAction");

  const userCbs = Array.from(document.querySelectorAll(".user-cb"));
  const serviceCbs = Array.from(document.querySelectorAll(".service-cb"));

  const selUsersCount = document.getElementById("selUsersCount");
  const selServicesCount = document.getElementById("selServicesCount");

  const selectAllUsers = document.getElementById("selectAllUsers");
  const selectAllServices = document.getElementById("selectAllServices");

  const userSearch = document.getElementById("userSearch");
  const serviceSearch = document.getElementById("serviceSearch");

  function selectedCount(list) {
    return list.filter(cb => cb.checked).length;
  }

  function refreshButtons() {
    const u = selectedCount(userCbs);
    const s = selectedCount(serviceCbs);
    selUsersCount.textContent = String(u);
    selServicesCount.textContent = String(s);

    const enabled = (u > 0 && s > 0);
    assignBtn.disabled = !enabled;
    unassignBtn.disabled = !enabled;

    if (selectAllUsers) {
      const anyUsers = userCbs.length > 0;
      selectAllUsers.indeterminate = anyUsers && u > 0 && u < userCbs.length;
      selectAllUsers.checked = anyUsers && u === userCbs.length;
    }
    if (selectAllServices) {
      const anySvcs = serviceCbs.length > 0;
      selectAllServices.indeterminate = anySvcs && s > 0 && s < serviceCbs.length;
      selectAllServices.checked = anySvcs && s === serviceCbs.length;
    }
  }

  userCbs.forEach(cb => cb.addEventListener("change", refreshButtons));
  serviceCbs.forEach(cb => cb.addEventListener("change", refreshButtons));

  if (selectAllUsers) {
    selectAllUsers.addEventListener("change", function () {
      userCbs.forEach(cb => cb.checked = selectAllUsers.checked);
      refreshButtons();
    });
  }
  if (selectAllServices) {
    selectAllServices.addEventListener("change", function () {
      serviceCbs.forEach(cb => cb.checked = selectAllServices.checked);
      refreshButtons();
    });
  }

  if (assignBtn) {
    assignBtn.addEventListener("click", function () {
      actionInput.value = "assign";
    });
  }
  if (unassignBtn) {
    unassignBtn.addEventListener("click", function () {
      actionInput.value = "unassign";
    });
  }

  function filterTable(inputEl, tableId) {
    const q = (inputEl.value || "").toLowerCase().trim();
    const table = document.getElementById(tableId);
    if (!table) return;
    const rows = Array.from(table.querySelectorAll("tbody tr"));
    rows.forEach(tr => {
      const t = (tr.dataset.text || tr.textContent || "").toLowerCase();
      tr.style.display = (!q || t.includes(q)) ? "" : "none";
    });
  }

  if (userSearch) userSearch.addEventListener("input", () => filterTable(userSearch, "usersTable"));
  if (serviceSearch) serviceSearch.addEventListener("input", () => filterTable(serviceSearch, "servicesTable"));

  refreshButtons();
})();
</script>
{% endblock %}
