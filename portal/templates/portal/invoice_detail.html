{% extends "portal/base_portal.html" %}

{% block title_suffix %} · Invoice · {{ invoice.invoice_number }}{% endblock %}

{% block content %}
<div class="row g-3">

    <!-- HEADER -->
    <div class="col-12">
        <div class="portal-card">
            <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
                <div>
                    <div class="section-eyebrow mb-1">Invoicing · Detail</div>
                    <h1 class="section-title mb-1">Invoice {{ invoice.invoice_number }}</h1>
                    <p class="section-subtitle mb-0">
                        Vendor:
                        <a href="{% url 'portal:vendor_detail' invoice.vendor.pk %}"
                           class="link-inline">
                            {{ invoice.vendor.name }}
                        </a>
                        {% if invoice.contract %}
                            · Contract:
                            <a href="{% url 'portal:contract_detail' invoice.contract.pk %}"
                               class="link-inline">
                                {{ invoice.contract.contract_name }}
                            </a>
                        {% endif %}
                    </p>
                </div>

                <div class="text-end">
                    <div class="metric-label mb-1">Total amount</div>
                    <div class="metric-value" style="font-size:1.3rem;">
                        {{ invoice.total_amount }} {{ invoice.currency }}
                    </div>
                    {% if invoice.tax_amount %}
                        <div class="portal-card-muted small">
                            Tax / VAT: {{ invoice.tax_amount }} {{ invoice.currency }}
                        </div>
                    {% endif %}

                    {% if invoice.file %}
                        <div class="mt-3">
                            <a href="{{ invoice.file.url }}" target="_blank" rel="noopener"
                               class="btn btn-ghost btn-sm">
                                Open invoice PDF
                            </a>
                        </div>
                    {% endif %}

                    <div class="mt-3">
                        <a href="{% url 'portal:invoices' %}" class="btn btn-ghost btn-sm">
                            Back to invoices
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- LEFT: CORE INVOICE DATA -->
    <div class="col-lg-7">
        <div class="portal-card h-100">
            <h6 class="mb-2">Invoice details</h6>
            <p class="portal-card-muted mb-3">
                Basic header fields as received from Finance / AP – number, date, period and amounts.
            </p>

            <div class="row gy-3">
                <div class="col-sm-6">
                    <div class="metric-label mb-1">Invoice number</div>
                    <div>{{ invoice.invoice_number }}</div>
                </div>
                <div class="col-sm-6">
                    <div class="metric-label mb-1">Invoice date</div>
                    <div>{{ invoice.invoice_date }}</div>
                </div>

                <div class="col-sm-6">
                    <div class="metric-label mb-1">Currency</div>
                    <div>{{ invoice.currency }}</div>
                </div>
                <div class="col-sm-6">
                    <div class="metric-label mb-1">Total amount</div>
                    <div>{{ invoice.total_amount }}</div>
                </div>

                <div class="col-sm-6">
                    <div class="metric-label mb-1">Tax / VAT</div>
                    <div>{{ invoice.tax_amount|default:"—" }}</div>
                </div>

                <div class="col-sm-6">
                    <div class="metric-label mb-1">Owner (portal)</div>
                    <div>{{ invoice.owner.username }}</div>
                </div>

                <div class="col-sm-6">
                    <div class="metric-label mb-1">Billing period from</div>
                    <div>{{ invoice.period_start|default:"—" }}</div>
                </div>
                <div class="col-sm-6">
                    <div class="metric-label mb-1">Billing period to</div>
                    <div>{{ invoice.period_end|default:"—" }}</div>
                </div>

                <div class="col-sm-6">
                    <div class="metric-label mb-1">Created</div>
                    <div>{{ invoice.created_at|date:"Y-m-d H:i" }}</div>
                </div>
                <div class="col-sm-6">
                    <div class="metric-label mb-1">Last updated</div>
                    <div>{{ invoice.updated_at|date:"Y-m-d H:i" }}</div>
                </div>
            </div>
        </div>
    </div>

    <!-- RIGHT: SPLITS / LINES -->
    <div class="col-lg-5 d-flex flex-column gap-3">

        <div class="portal-card">
            <h6 class="mb-2">Line items</h6>
            <p class="portal-card-muted mb-3">
                Individual invoice lines with service mapping, cost centre and user allocation.
            </p>

            {% if lines %}
                <div class="table-responsive">
                    <table class="portal-table align-middle">
                        <thead>
                            <tr>
                                <th style="width:30%;">Description</th>
                                <th style="width:24%;">Service</th>
                                <th style="width:18%;">Cost centre</th>
                                <th style="width:18%;">User</th>
                                <th style="width:10%;">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for l in lines %}
                                <tr>
                                    <td class="cell-muted">{{ l.description }}</td>
                                    <td class="cell-muted">
                                        {% if l.service %}
                                            {{ l.service.name }}
                                        {% else %}
                                            —
                                        {% endif %}
                                    </td>
                                    <td class="cell-muted">
                                        {% if l.cost_center %}
                                            {{ l.cost_center.code }}
                                        {% else %}
                                            —
                                        {% endif %}
                                    </td>
                                    <td class="cell-muted">
                                        {% if l.user %}
                                            {{ l.user.username }}
                                        {% else %}
                                            —
                                        {% endif %}
                                    </td>
                                    <td class="cell-muted text-end">
                                        {{ l.line_amount }}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="portal-card-muted mb-0">
                    No line-level splits captured for this invoice yet.
                </p>
            {% endif %}
        </div>

        <div class="portal-card">
            <h6 class="mb-2">Cost centre allocation</h6>
            <p class="portal-card-muted mb-3">
                Aggregated view of line items by cost centre.
            </p>

            {% if allocation_by_cost_center %}
                <div class="table-responsive">
                    <table class="portal-table align-middle">
                        <thead>
                            <tr>
                                <th style="width:50%;">Cost centre</th>
                                <th style="width:50%;">Allocated amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in allocation_by_cost_center %}
                                <tr>
                                    <td class="cell-muted">
                                        {% if row.cost_center__code %}
                                            {{ row.cost_center__code }} – {{ row.cost_center__name }}
                                        {% else %}
                                            Unassigned
                                        {% endif %}
                                    </td>
                                    <td class="cell-muted text-end">
                                        {{ row.total }}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="portal-card-muted mb-0">
                    No cost centre allocation recorded.
                </p>
            {% endif %}
        </div>

        <div class="portal-card">
            <h6 class="mb-2">Service breakdown</h6>
            <p class="portal-card-muted mb-3">
                Spend by service / product on this invoice.
            </p>

            {% if service_breakdown %}
                <div class="table-responsive">
                    <table class="portal-table align-middle">
                        <thead>
                            <tr>
                                <th style="width:60%;">Service</th>
                                <th style="width:40%;">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in service_breakdown %}
                                <tr>
                                    <td class="cell-muted">
                                        {% if row.service__name %}
                                            {{ row.service__vendor__name }} – {{ row.service__name }}
                                        {% else %}
                                            Unmapped to service
                                        {% endif %}
                                    </td>
                                    <td class="cell-muted text-end">
                                        {{ row.total }}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="portal-card-muted mb-0">
                    No service-level mapping for this invoice yet.
                </p>
            {% endif %}
        </div>

    </div>
</div>
{% endblock %}
