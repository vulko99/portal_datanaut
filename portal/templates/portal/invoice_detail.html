{% extends "portal/base_portal.html" %}

{% block title_suffix %} · Invoice · {{ invoice.invoice_number }}{% endblock %}

{% block content %}
<div class="row g-3">

    <!-- HEADER -->
    <div class="col-12">
        <div class="portal-card">
            <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
                <div>
                    <div class="section-eyebrow mb-1">Invoicing · Detail</div>
                    <h1 class="section-title mb-1">Invoice {{ invoice.invoice_number }}</h1>
                    <p class="section-subtitle mb-0">
                        Vendor:
                        <a href="{% url 'portal:vendor_detail' invoice.vendor.pk %}" class="link-inline">
                            {{ invoice.vendor.name }}
                        </a>
                        {% if invoice.contract %}
                            · Contract:
                            <a href="{% url 'portal:contract_detail' invoice.contract.pk %}" class="link-inline">
                                {{ invoice.contract.contract_name }}
                            </a>
                        {% endif %}
                    </p>
                </div>

                <div class="text-end">
                    <div class="metric-label mb-1">Total amount</div>
                    <div class="metric-value" style="font-size:1.4rem;">
                        {{ invoice.total_amount }} {{ invoice.currency }}
                    </div>

                    {% if invoice.file %}
                        <div class="mt-3">
                            <a href="{{ invoice.file.url }}" target="_blank" rel="noopener"
                               class="btn btn-ghost btn-sm">
                                Open invoice PDF
                            </a>
                        </div>
                    {% endif %}

                    <div class="d-flex justify-content-end flex-wrap gap-2 mt-3">
                        <a href="{% url 'portal:invoices' %}" class="btn btn-ghost btn-sm">
                            Back to invoices
                        </a>

                        <button type="button" id="invoice-cancel-btn"
                                class="btn btn-ghost btn-sm d-none">
                            Cancel
                        </button>

                        <button type="button" id="invoice-edit-btn"
                                class="btn btn-add btn-sm">
                            Edit
                        </button>

                        <button type="button" id="invoice-delete-open"
                                class="btn btn-ghost btn-sm">
                            Delete
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- LEFT: VIEW MODE -->
    <div class="col-lg-7" id="invoice-view-mode">
        <div class="portal-card h-100">
            <h6 class="mb-2">Invoice details</h6>
            <p class="portal-card-muted mb-3">
                Basic header fields as received from Finance / AP – number, date, period and amounts.
            </p>

            <div class="row gy-3">
                <div class="col-sm-6">
                    <div class="metric-label mb-1">Vendor</div>
                    <div>{{ invoice.vendor.name }}</div>
                </div>
                <div class="col-sm-6">
                    <div class="metric-label mb-1">Contract</div>
                    <div>
                        {% if invoice.contract %}
                            <a href="{% url 'portal:contract_detail' invoice.contract.pk %}" class="link-inline">
                                {{ invoice.contract.contract_name }}
                            </a>
                        {% else %}
                            —
                        {% endif %}
                    </div>
                </div>

                <div class="col-sm-6">
                    <div class="metric-label mb-1">Invoice number</div>
                    <div>{{ invoice.invoice_number }}</div>
                </div>
                <div class="col-sm-6">
                    <div class="metric-label mb-1">Invoice date</div>
                    <div>
                        {% if invoice.invoice_date %}
                            {{ invoice.invoice_date|date:"M. d, Y" }}
                        {% else %}
                            —
                        {% endif %}
                    </div>
                </div>

                <div class="col-sm-6">
                    <div class="metric-label mb-1">Currency</div>
                    <div>{{ invoice.currency }}</div>
                </div>
                <div class="col-sm-6">
                    <div class="metric-label mb-1">Total amount</div>
                    <div>{{ invoice.total_amount }}</div>
                </div>

                <div class="col-sm-6">
                    <div class="metric-label mb-1">Tax / VAT</div>
                    <div>
                        {% if invoice.tax_amount is not None %}
                            {{ invoice.tax_amount }}
                        {% else %}
                            —
                        {% endif %}
                    </div>
                </div>
                <div class="col-sm-6">
                    <div class="metric-label mb-1">Owner (portal)</div>
                    <div>{{ invoice.owner.username }}</div>
                </div>

                <div class="col-sm-6">
                    <div class="metric-label mb-1">Billing period from</div>
                    <div>
                        {% if invoice.period_start %}
                            {{ invoice.period_start|date:"M. d, Y" }}
                        {% else %}
                            —
                        {% endif %}
                    </div>
                </div>
                <div class="col-sm-6">
                    <div class="metric-label mb-1">Billing period to</div>
                    <div>
                        {% if invoice.period_end %}
                            {{ invoice.period_end|date:"M. d, Y" }}
                        {% else %}
                            —
                        {% endif %}
                    </div>
                </div>

                <div class="col-sm-6">
                    <div class="metric-label mb-1">Created</div>
                    <div>{{ invoice.created_at|date:"Y-m-d H:i" }}</div>
                </div>
                <div class="col-sm-6">
                    <div class="metric-label mb-1">Last updated</div>
                    <div>{{ invoice.updated_at|date:"Y-m-d H:i" }}</div>
                </div>

                <div class="col-12">
                    <div class="metric-label mb-1">Notes</div>
                    <div>{{ invoice.notes|default:"—" }}</div>
                </div>
            </div>
        </div>
    </div>

    <!-- LEFT: EDIT MODE -->
    <div class="col-lg-7 d-none" id="invoice-edit-mode">
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="hidden" name="action" value="update">
            <div class="portal-card h-100">
                <h6 class="mb-2">Invoice details</h6>
                <p class="portal-card-muted mb-3">
                    Update header fields for this invoice. Use Save changes to apply.
                </p>

                <div class="row g-3 small">
                    <div class="col-md-6">
                        <label class="form-label form-label-sm">Vendor</label>
                        <select name="vendor_id" class="form-select form-select-sm">
                            <option value="">---------</option>
                            {% for v in vendors %}
                                <option value="{{ v.pk }}" {% if v.pk == invoice.vendor_id %}selected{% endif %}>
                                    {{ v.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label form-label-sm">Contract</label>
                        <select name="contract_id" class="form-select form-select-sm">
                            <option value="">---------</option>
                            {% for c in contracts %}
                                <option value="{{ c.pk }}" {% if invoice.contract_id == c.pk %}selected{% endif %}>
                                    {{ c.vendor.name }} – {{ c.contract_name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label form-label-sm">Invoice number</label>
                        <input type="text" name="invoice_number" class="form-control form-control-sm"
                               value="{{ invoice.invoice_number }}">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label form-label-sm">Invoice date</label>
                        <input type="date" name="invoice_date" class="form-control form-control-sm"
                               value="{{ invoice.invoice_date|date:'Y-m-d' }}">
                    </div>

                    <div class="col-md-3">
                        <label class="form-label form-label-sm">Currency</label>
                        <input type="text" name="currency" class="form-control form-control-sm"
                               value="{{ invoice.currency }}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label form-label-sm">Total amount</label>
                        <input type="text" name="total_amount" class="form-control form-control-sm"
                               value="{{ invoice.total_amount }}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label form-label-sm">Tax / VAT</label>
                        <input type="text" name="tax_amount" class="form-control form-control-sm"
                               value="{{ invoice.tax_amount|default_if_none:'' }}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label form-label-sm">Owner (portal)</label>
                        <input type="text" class="form-control form-control-sm" value="{{ invoice.owner.username }}"
                               disabled>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label form-label-sm">Billing period from</label>
                        <input type="date" name="period_start" class="form-control form-control-sm"
                               value="{{ invoice.period_start|date:'Y-m-d' }}">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label form-label-sm">Billing period to</label>
                        <input type="date" name="period_end" class="form-control form-control-sm"
                               value="{{ invoice.period_end|date:'Y-m-d' }}">
                    </div>

                    <div class="col-md-6">
                        <label class="form-label form-label-sm">Invoice PDF</label>
                        <input type="file" name="file" class="form-control form-control-sm">
                        <div class="form-text text-muted">
                            Leave blank to keep existing file.
                        </div>
                    </div>

                    <div class="col-12">
                        <label class="form-label form-label-sm">Notes</label>
                        <textarea name="notes" rows="3"
                                  class="form-control form-control-sm">{{ invoice.notes }}</textarea>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label form-label-sm">Created</label>
                        <input type="text" class="form-control form-control-sm"
                               value="{{ invoice.created_at|date:'Y-m-d H:i' }}" disabled>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label form-label-sm">Last updated</label>
                        <input type="text" class="form-control form-control-sm"
                               value="{{ invoice.updated_at|date:'Y-m-d H:i' }}" disabled>
                    </div>
                </div>

                <div class="d-flex justify-content-end gap-2 mt-3">
                    <button type="submit" class="btn btn-add btn-sm">
                        Save changes
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- RIGHT: ALLOCATION & SERVICE BREAKDOWN -->
    <div class="col-lg-5 d-flex flex-column gap-3">
        <div class="portal-card">
            <h6 class="mb-2">Invoice lines (cost allocation)</h6>
            {% if lines %}
                {% if allocation_by_cost_center %}
                    <div class="table-responsive mb-3">
                        <table class="portal-table align-middle">
                            <thead>
                            <tr>
                                <th>Cost centre</th>
                                <th class="text-end">Total</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for row in allocation_by_cost_center %}
                                <tr>
                                    <td class="cell-muted">
                                        {% if row.cost_center__code %}
                                            {{ row.cost_center__code }} – {{ row.cost_center__name }}
                                        {% else %}
                                            Unallocated
                                        {% endif %}
                                    </td>
                                    <td class="cell-muted text-end">{{ row.total }}</td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% endif %}
                <p class="portal-card-muted mb-0">
                    View individual invoice lines in the allocation table (coming soon in UI).
                </p>
            {% else %}
                <p class="portal-card-muted mb-0">
                    No line-level allocation captured for this invoice.
                </p>
            {% endif %}
        </div>

        <div class="portal-card">
            <h6 class="mb-2">Service breakdown</h6>
            {% if service_breakdown %}
                <div class="table-responsive">
                    <table class="portal-table align-middle">
                        <thead>
                        <tr>
                            <th>Service</th>
                            <th class="text-end">Total</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for row in service_breakdown %}
                            <tr>
                                <td class="cell-muted">
                                    {% if row.service__vendor__name %}
                                        {{ row.service__vendor__name }} ·
                                    {% endif %}
                                    {{ row.service__name }}
                                </td>
                                <td class="cell-muted text-end">{{ row.total }}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="portal-card-muted mb-0">
                    No service-level split available.
                </p>
            {% endif %}
        </div>
    </div>
</div>

<!-- DELETE MODAL -->
<div id="invoice-delete-backdrop" class="portal-modal-backdrop d-none">
    <div class="portal-modal-card">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="mb-0">Delete invoice</h6>
            <button type="button" class="btn btn-ghost btn-sm delete-invoice-cancel" aria-label="Close">
                ✕
            </button>
        </div>
        <p class="mb-2">
            Are you sure you want to delete invoice <strong>{{ invoice.invoice_number }}</strong>?
        </p>
        <p class="portal-card-muted mb-4">
            This action cannot be undone.
        </p>

        <form method="post" id="invoice-delete-form">
            {% csrf_token %}
            <input type="hidden" name="action" value="delete">
            <div class="d-flex justify-content-end gap-2">
                <button type="button" class="btn btn-ghost btn-sm delete-invoice-cancel">
                    Cancel
                </button>
                <button type="submit" class="btn btn-danger btn-sm">
                    Delete
                </button>
            </div>
        </form>
    </div>
</div>

<style>
.portal-modal-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(3, 6, 23, 0.85);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1100;
}

.portal-modal-card {
    background: #050816;
    border-radius: 12px;
    padding: 1.5rem 1.75rem;
    max-width: 520px;
    width: 100%;
    box-shadow: 0 24px 80px rgba(0, 0, 0, 0.65);
}
</style>

<script>
(function () {
    const viewMode = document.getElementById("invoice-view-mode");
    const editMode = document.getElementById("invoice-edit-mode");
    const editBtn = document.getElementById("invoice-edit-btn");
    const cancelBtn = document.getElementById("invoice-cancel-btn");

    if (editBtn && viewMode && editMode && cancelBtn) {
        editBtn.addEventListener("click", function () {
            viewMode.classList.add("d-none");
            editMode.classList.remove("d-none");
            editBtn.classList.add("d-none");
            cancelBtn.classList.remove("d-none");
        });

        cancelBtn.addEventListener("click", function () {
            window.location.reload();
        });
    }

    const openDeleteBtn = document.getElementById("invoice-delete-open");
    const backdrop = document.getElementById("invoice-delete-backdrop");
    const cancelDeleteBtns = document.querySelectorAll(".delete-invoice-cancel");

    if (openDeleteBtn && backdrop) {
        openDeleteBtn.addEventListener("click", function () {
            backdrop.classList.remove("d-none");
        });

        cancelDeleteBtns.forEach(function (btn) {
            btn.addEventListener("click", function () {
                backdrop.classList.add("d-none");
            });
        });

        backdrop.addEventListener("click", function (e) {
            if (e.target === backdrop) {
                backdrop.classList.add("d-none");
            }
        });
    }
})();
</script>
{% endblock %}
