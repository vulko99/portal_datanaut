{% extends "portal/base_portal.html" %}

{% block title_suffix %} · Users{% endblock %}

{% block content %}
<div class="row g-3">
    <div class="col-12">
        <div class="portal-card">
            <div class="section-header mb-2">
                <div class="section-eyebrow">Inventory</div>
                <h1 class="section-title mb-0">Users</h1>
                <p class="section-subtitle mb-0">
                    Your users with profile data, cost centers and manager relationships.
                </p>
            </div>

            <div class="d-flex flex-wrap align-items-center justify-content-between mt-1 mb-2">
                <div class="d-flex flex-wrap gap-2">
                    <div>
                        <div class="metric-label">Total users</div>
<div class="metric-value">
    {{ total_users }}
</div>
<div class="small text-muted">
    Showing {{ users|length }} of {{ total_users }}
</div>
                    </div>
                </div>
                <div class="text-end small text-muted">
                    Use the global <strong>Add</strong> button in the top bar to create a new user.
                </div>
            </div>

            <!-- TOOLBAR: search + filters -->
            <div class="d-flex flex-wrap justify-content-between align-items-center mb-2">
                <div class="d-flex flex-wrap gap-2 align-items-center">
                    <div class="input-group input-group-sm" style="max-width: 320px;">
                        <span class="input-group-text">Search</span>
                        <input
                            type="search"
                            id="userSearch"
                            class="form-control"
                            placeholder="Username, name, email…">
                    </div>

                    <select id="statusFilter" class="form-select form-select-sm" style="min-width: 160px;">
                        <option value="">All statuses</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>

                    <select id="costCenterFilter" class="form-select form-select-sm" style="min-width: 180px;">
                        <option value="">All cost centers</option>
                    </select>

                    <select id="managerFilter" class="form-select form-select-sm" style="min-width: 180px;">
                        <option value="">All managers</option>
                    </select>

                    {# Show closed toggle – пазим и rows параметъра #}
                    <form method="get" class="small">
                        {# default: hide closed #}
                        <input type="hidden" name="show_closed" value="0">
                        <input type="hidden" name="rows" value="{{ rows_per_page|default_if_none:50 }}">

                        <div class="form-check form-switch m-0">
                            <input class="form-check-input"
                                   type="checkbox"
                                   id="users-show-closed-toggle"
                                   name="show_closed"
                                   value="1"
                                   {% if show_closed %}checked{% endif %}
                                   onchange="this.form.submit()">
                            <label class="form-check-label" for="users-show-closed-toggle">
                                Show closed
                            </label>
                        </div>
                    </form>

                    {# NEW: rows-per-page selector #}
                    <form method="get" class="small">
                        <input type="hidden" name="show_closed" value="{% if show_closed %}1{% else %}0{% endif %}">
                        <div class="d-flex align-items-center gap-1">
                            <label for="rows-per-page" class="form-label mb-0 small text-muted">
                                Rows:
                            </label>
                            <select id="rows-per-page"
                                    name="rows"
                                    class="form-select form-select-sm"
                                    onchange="this.form.submit()"
                                    style="width:auto; min-width: 80px;">
                                {% for opt in rows_options %}
                                    <option value="{{ opt }}"
                                            {% if rows_per_page == opt %}selected{% endif %}>
                                        {{ opt }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    </form>
                </div>
            </div>

            <!-- USER GRID -->
            {% if users %}
                <div class="table-responsive" style="max-height: 520px; overflow-y: auto;">
                    <table class="portal-table align-middle">
                        <thead>
                        <tr>
                            <th style="width: 18%;">User</th>
                            <th style="width: 18%;">Full name</th>
                            <th style="width: 20%;">Email</th>
                            <th style="width: 14%;">Status</th>
                            <th style="width: 14%;">Cost center</th>
                            <th style="width: 16%;">Manager</th>
                        </tr>
                        </thead>
                        <tbody id="usersTableBody">
                        {% for u in users %}
                            <tr
                                data-username="{{ u.username|default_if_none:'' }}"
                                data-full-name="{{ u.profile.full_name|default_if_none:'' }}"
                                data-email="{{ u.email|default_if_none:'' }}"
                                data-status="{% if u.is_active %}active{% else %}inactive{% endif %}"
                                data-cost-center="{{ u.profile.cost_center.code|default_if_none:'' }}"
                                data-manager="{{ u.profile.manager.username|default_if_none:'' }}"
                            >
                                <td>
                                    <a href="{% url 'portal:user_detail' u.pk %}" class="link-table">
                                        {{ u.username }}
                                        {% if not u.is_active %}
                                            <span class="badge rounded-pill bg-secondary ms-2">Closed</span>
                                        {% endif %}
                                    </a>
                                </td>
                                <td class="cell-muted">{{ u.profile.full_name|default:"—" }}</td>
                                <td class="cell-muted">{{ u.email|default:"—" }}</td>
                                <td class="cell-muted">
                                    {% if u.is_active %}Active{% else %}Closed{% endif %}
                                </td>
                                <td class="cell-muted">
                                    {% if u.profile.cost_center %}
                                        {{ u.profile.cost_center.code }} – {{ u.profile.cost_center.name }}
                                    {% else %}
                                        —
                                    {% endif %}
                                </td>
                                <td class="cell-muted">
                                    {% if u.profile.manager %}
                                        {{ u.profile.manager.username }}
                                    {% else %}
                                        —
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>

                <p class="portal-card-muted mb-0 mt-2">
                    Over time this grid can power access reviews and user-level allocation splits.
                </p>

                {% if not show_closed %}
                    <p class="portal-card-muted mb-0 mt-1">
                        Closed users are hidden by default. Use <strong>Show closed</strong> to include them.
                    </p>
                {% endif %}
            {% else %}
                <p class="portal-card-muted mb-0">
                    No users yet. Add users to start linking them to cost centers and invoices.
                </p>
            {% endif %}
        </div>
    </div>
</div>

<!-- ADD USER MODAL (глобален Add на тази страница) -->
<div class="modal fade" id="addUserModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content" style="background: rgba(10,15,25,.96); color:#E5E7EB; border-radius:18px; border:1px solid rgba(148,163,184,.4);">
            <div class="modal-header border-0 pt-3 pb-1 px-4">
                <div>
                    <h5 class="modal-title">Add new user</h5>
                    <div class="small text-muted">
                        Create a new user with cost center and manager relationships.
                    </div>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body px-4 pb-4">
                <form method="post">
                    {% csrf_token %}
                    <div class="row g-3 mb-3">
                        <div class="col-md-6 col-xl-4">
                            <label class="form-label">Username</label>
                            <input type="text" class="form-control form-control-sm" placeholder="Username…">
                        </div>
                        <div class="col-md-6 col-xl-4">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control form-control-sm" placeholder="email@company.com">
                        </div>
                        <div class="col-md-6 col-xl-4">
                            <label class="form-label">Status</label>
                            <select class="form-select form-select-sm">
                                <option>Active</option>
                                <option>Inactive</option>
                            </select>
                        </div>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-md-6 col-xl-4">
                            <label class="form-label">Cost center</label>
                            <select class="form-select form-select-sm">
                                <option>NYC Trading</option>
                                <option>LDN Research</option>
                                <option>SGP Ops</option>
                            </select>
                        </div>
                        <div class="col-md-6 col-xl-4">
                            <label class="form-label">Manager</label>
                            <select class="form-select form-select-sm">
                                <option>@dan</option>
                                <option>@sana</option>
                                <option>@linda</option>
                            </select>
                        </div>
                        <div class="col-md-6 col-xl-4">
                            <label class="form-label">Title</label>
                            <input type="text" class="form-control form-control-sm" placeholder="Role / title…">
                        </div>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Region</label>
                            <input type="text" class="form-control form-control-sm" placeholder="Region…">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Legal entity</label>
                            <input type="text" class="form-control form-control-sm" placeholder="Legal entity…">
                        </div>
                    </div>

                    <div class="d-flex justify-content-end gap-2 mt-2">
                        <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-dismiss="modal">
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-sm btn-primary">
                            Save and close
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function () {
    const searchInput = document.getElementById('userSearch');
    const statusSelect = document.getElementById('statusFilter');
    const costCenterSelect = document.getElementById('costCenterFilter');
    const managerSelect = document.getElementById('managerFilter');
    const tableBody = document.getElementById('usersTableBody');
    const globalAddBtn = document.getElementById('globalAddButton');
    const addUserModalEl = document.getElementById('addUserModal');

    let rows = [];
    const costCenters = new Set();
    const managers = new Set();

    if (tableBody) {
        rows = Array.from(tableBody.querySelectorAll('tr'));

        // попълваме cost center / manager филтрите
        rows.forEach(row => {
            const cc = (row.dataset.costCenter || '').trim();
            const mgr = (row.dataset.manager || '').trim();
            if (cc) costCenters.add(cc);
            if (mgr) managers.add(mgr);
        });

        if (costCenterSelect) {
            Array.from(costCenters).sort().forEach(cc => {
                const opt = document.createElement('option');
                opt.value = cc;
                opt.textContent = cc;
                costCenterSelect.appendChild(opt);
            });
        }

        if (managerSelect) {
            Array.from(managers).sort().forEach(mgr => {
                const opt = document.createElement('option');
                opt.value = mgr;
                opt.textContent = mgr;
                managerSelect.appendChild(opt);
            });
        }

        function applyFilters() {
            const query = (searchInput ? searchInput.value : '').toLowerCase();
            const statusFilter = statusSelect ? statusSelect.value : '';
            const ccFilter = costCenterSelect ? costCenterSelect.value : '';
            const mgrFilter = managerSelect ? managerSelect.value : '';

            rows.forEach(row => {
                const username = (row.dataset.username || '').toLowerCase();
                const fullName = (row.dataset.fullName || '').toLowerCase();
                const email = (row.dataset.email || '').toLowerCase();
                const cc = (row.dataset.costCenter || '');
                const mgr = (row.dataset.manager || '');
                const status = (row.dataset.status || '');
                const fullText = (row.textContent || '').toLowerCase();

                const matchesText =
                    !query ||
                    username.includes(query) ||
                    fullName.includes(query) ||
                    email.includes(query) ||
                    fullText.includes(query);

                const matchesStatus =
                    !statusFilter || status === statusFilter;

                const matchesCC =
                    !ccFilter || cc === ccFilter;

                const matchesMgr =
                    !mgrFilter || mgr === mgrFilter;

                row.style.display = (matchesText && matchesStatus && matchesCC && matchesMgr) ? '' : 'none';
            });
        }

        if (searchInput) searchInput.addEventListener('input', applyFilters);
        if (statusSelect) statusSelect.addEventListener('change', applyFilters);
        if (costCenterSelect) costCenterSelect.addEventListener('change', applyFilters);
        if (managerSelect) managerSelect.addEventListener('change', applyFilters);
    }

    // Глобален Add бутон -> отваря user модала на тази страница
    if (globalAddBtn && addUserModalEl && window.bootstrap) {
        const modalInstance = new bootstrap.Modal(addUserModalEl);
        globalAddBtn.addEventListener('click', function () {
            modalInstance.show();
        });
    }

    // Ако има грешки след POST – отваряме модала автоматично
    const hasErrors = document.querySelector('#addUserModal .errorlist') !== null;
    if (hasErrors && addUserModalEl && window.bootstrap) {
        const modal = new bootstrap.Modal(addUserModalEl);
        modal.show();
    }
})();
</script>
{% endblock %}
