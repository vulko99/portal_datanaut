{% extends "portal/base_portal.html" %}

{% block title_suffix %} · Users{% endblock %}

{% block content %}
{% with cp=page_obj.number|default:1 %}
{% with sc=show_closed|yesno:"1,0" %}

<div class="row g-3">
  <div class="col-12">
    <div class="portal-card">
      {# HEADER – същият layout като services/vendors #}
      <div class="section-header mb-2">
        <div class="section-eyebrow">Inventory</div>
        <h1 class="section-title mb-0">Users</h1>
        <p class="section-subtitle mb-0">
          Your users with profile data, cost centers and manager relationships.
        </p>
      </div>

      <div class="d-flex flex-wrap align-items-center justify-content-between mt-1 mb-2">
        <div class="small text-muted">
          <span class="me-3">
            Total users: <strong>{{ total_users }}</strong>
          </span>
          <span>
            Showing {{ users|length }} on this page
          </span>
        </div>
        <div class="text-end small text-muted">
          Use the global <strong>Add</strong> button in the top bar to create a new user.
        </div>
      </div>

      {# TOOLBAR: Show closed + Rows (копие на services/vendors) #}
      <div class="d-flex flex-wrap justify-content-between align-items-center mb-2">
        <div class="d-flex flex-wrap gap-3 align-items-center">

          {# Show closed toggle – пазим page/rows/selected #}
          <form method="get" class="small d-flex align-items-center gap-3">
            <input type="hidden" name="show_closed" value="0">
            <input type="hidden" name="page" value="{{ cp }}">
            <input type="hidden" name="rows" value="{{ rows_per_page|default:50 }}">
            {% if selected_user %}
              <input type="hidden" name="selected" value="{{ selected_user.id }}">
            {% endif %}

            <div class="form-check form-switch m-0">
              <input class="form-check-input"
                     type="checkbox"
                     id="users-show-closed-toggle"
                     name="show_closed"
                     value="1"
                     {% if show_closed %}checked{% endif %}
                     onchange="this.form.submit()">
              <label class="form-check-label" for="users-show-closed-toggle">
                Show closed
              </label>
            </div>
          </form>

          {# Rows selector – отделна форма, същата логика като при services/vendors #}
          <form method="get" class="small d-flex align-items-center gap-2">
            <input type="hidden" name="page" value="{{ cp }}">
            <input type="hidden" name="show_closed" value="{{ sc }}">
            {% if selected_user %}
              <input type="hidden" name="selected" value="{{ selected_user.id }}">
            {% endif %}

            <span class="text-muted">Rows:</span>
            <select name="rows"
                    class="form-select form-select-sm"
                    style="width:auto; min-width: 90px;"
                    onchange="this.form.submit()">
              <option value="10"  {% if rows_per_page == 10  %}selected{% endif %}>10</option>
              <option value="20"  {% if rows_per_page == 20  %}selected{% endif %}>20</option>
              <option value="30"  {% if rows_per_page == 30  %}selected{% endif %}>30</option>
              <option value="50"  {% if rows_per_page == 50  or not rows_per_page %}selected{% endif %}>50</option>
              <option value="100" {% if rows_per_page == 100 %}selected{% endif %}>100</option>
              <option value="250" {% if rows_per_page == 250 %}selected{% endif %}>250</option>
            </select>
          </form>

        </div>
      </div>

      {# USER GRID – wrapper/височина като при services/vendors #}
      {% if users %}
        <div class="table-responsive" style="max-height: 420px; overflow-y: auto;">
          <table class="portal-table align-middle">
            <thead>
              <tr>
                <th style="width: 18%;">User</th>
                <th style="width: 18%;">Full name</th>
                <th style="width: 20%;">Email</th>
                <th style="width: 14%;">Status</th>
                <th style="width: 14%;">Cost center</th>
                <th style="width: 16%;">Manager</th>
              </tr>
            </thead>
            <tbody>
              {% for u in users %}
                <tr {% if selected_user and u.id == selected_user.id %}style="background: rgba(20,244,212,.06);"{% endif %}>
                  <td>
                    <a
                      href="?page={{ cp }}&rows={{ rows_per_page|default:50 }}&show_closed={{ sc }}&selected={{ u.id }}#user-details"
                      class="link-table"
                    >
                      {{ u.username }}
                      {% if not u.is_active %}
                        <span class="badge rounded-pill bg-secondary ms-2">Closed</span>
                      {% endif %}
                    </a>
                  </td>
                  <td class="cell-muted">{{ u.profile.full_name|default:"—" }}</td>
                  <td class="cell-muted">{{ u.email|default:"—" }}</td>
                  <td class="cell-muted">{% if u.is_active %}Active{% else %}Closed{% endif %}</td>
                  <td class="cell-muted">
                    {% if u.profile.cost_center %}
                      {{ u.profile.cost_center.code }} – {{ u.profile.cost_center.name }}
                    {% else %}
                      — 
                    {% endif %}
                  </td>
                  <td class="cell-muted">
                    {% if u.profile.manager %}
                      {{ u.profile.manager.username }}
                    {% else %}
                      — 
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <p class="portal-card-muted mb-0 mt-2">
          Over time this grid can power access reviews and user-level allocation splits.
        </p>

        {% if not show_closed %}
          <p class="portal-card-muted mb-0 mt-1">
            Closed users are hidden by default. Use <strong>Show closed</strong> to include them.
          </p>
        {% endif %}

        {# PAGINATION – същият layout като при services/vendors #}
        {% if page_obj %}
          <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mt-3">
            <div class="small text-muted">
              Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
            </div>

            <nav aria-label="Users pagination">
              <ul class="pagination pagination-sm mb-0">
                <li class="page-item {% if not page_obj.has_previous %}disabled{% endif %}">
                  {% if page_obj.has_previous %}
                    <a class="page-link"
                       href="?page={{ page_obj.previous_page_number }}&rows={{ rows_per_page|default:50 }}&show_closed={{ sc }}{% if selected_user %}&selected={{ selected_user.id }}{% endif %}#users">
                      Prev
                    </a>
                  {% else %}
                    <span class="page-link">Prev</span>
                  {% endif %}
                </li>

                {% for p in page_obj.paginator.page_range %}
                  {% if p == 1 or p == page_obj.paginator.num_pages or p >= page_obj.number|add:-2 and p <= page_obj.number|add:2 %}
                    <li class="page-item {% if p == page_obj.number %}active{% endif %}">
                      <a class="page-link"
                         href="?page={{ p }}&rows={{ rows_per_page|default:50 }}&show_closed={{ sc }}{% if selected_user %}&selected={{ selected_user.id }}{% endif %}#users">
                        {{ p }}
                      </a>
                    </li>
                  {% endif %}
                {% endfor %}

                <li class="page-item {% if not page_obj.has_next %}disabled{% endif %}">
                  {% if page_obj.has_next %}
                    <a class="page-link"
                       href="?page={{ page_obj.next_page_number }}&rows={{ rows_per_page|default:50 }}&show_closed={{ sc }}{% if selected_user %}&selected={{ selected_user.id }}{% endif %}#users">
                      Next
                    </a>
                  {% else %}
                    <span class="page-link">Next</span>
                  {% endif %}
                </li>
              </ul>
            </nav>
          </div>
        {% endif %}

      {% else %}
        <p class="portal-card-muted mb-0">
          No users yet. Add users to start linking them to cost centers and invoices.
        </p>
      {% endif %}
    </div>
  </div>

  {# INLINE USER DETAILS + AUDIT – същия патърн като vendors/services #}
  <div class="col-12" id="user-details">
    {% if selected_user %}
      <div class="portal-card">
        <div class="d-flex justify-content-between align-items-start mb-2">
          <div class="flex-grow-1">
            <div class="d-flex align-items-center gap-2 mb-2">
              <button id="userDetailsTab"
                      type="button"
                      class="btn btn-sm btn-ghost">
                User details
              </button>
              <button id="userAuditTab"
                      type="button"
                      class="btn btn-sm btn-ghost">
                Audit · Change log
              </button>
            </div>
            <div class="section-title mb-0">{{ selected_user.username }}</div>
            <div class="section-subtitle mb-0">
              {{ selected_user.profile.full_name|default:"—" }} · {{ selected_user.email|default:"—" }}
            </div>
          </div>
          <div class="small text-muted text-end">
            Make changes below and <strong>Save</strong>.
          </div>
        </div>

        {# AUDIT PANEL #}
        <div class="mb-3 d-none" id="userAuditPanel">
          <div class="portal-card" style="padding:14px;">
            <div class="section-eyebrow mb-1">Audit</div>
            <div class="section-title" style="font-size:1.05rem;">Change log</div>
            <div class="portal-card-muted mb-2">
              Latest changes for this user.
            </div>

            {% if audit_events %}
              <div class="table-responsive" style="max-height: 260px; overflow-y: auto;">
                <table class="portal-table align-middle mb-0">
                  <thead>
                    <tr>
                      <th style="width:22%;">When</th>
                      <th style="width:18%;">Actor</th>
                      <th style="width:60%;">Change</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for ev in audit_events %}
                      <tr>
                        <td class="cell-muted">
                          {% if ev.occurred_at %}
                            {{ ev.occurred_at|date:"Y-m-d H:i" }}
                          {% elif ev.created_at %}
                            {{ ev.created_at|date:"Y-m-d H:i" }}
                          {% elif ev.timestamp %}
                            {{ ev.timestamp|date:"Y-m-d H:i" }}
                          {% else %}
                            —
                          {% endif %}
                        </td>
                        <td class="cell-muted">
                          {% if ev.actor_display %}
                            {{ ev.actor_display }}
                          {% elif ev.actor %}
                            {{ ev.actor }}
                          {% else %}
                            —
                          {% endif %}
                        </td>
                        <td class="cell-muted">
                          {{ ev.description|default:"—" }}
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <div class="portal-card-muted">No audit events yet.</div>
            {% endif %}
          </div>
        </div>

        {# USER DETAILS PANEL #}
        <div id="userDetailsPanel">
          <div class="row g-3">
            <div class="col-12 col-xl-8">
              <form method="post">
                {% csrf_token %}
                <input type="hidden" name="selected" value="{{ selected_user.id }}">
                <input type="hidden" name="page" value="{{ cp }}">
                <input type="hidden" name="rows" value="{{ rows_per_page|default:50 }}">
                <input type="hidden" name="show_closed" value="{{ sc }}">

                <div class="row g-3">
                  <div class="col-md-4">
                    <label class="form-label small text-muted">Username</label>
                    <input class="form-control form-control-sm" name="username" value="{{ selected_user.username }}">
                  </div>
                  <div class="col-md-4">
                    <label class="form-label small text-muted">Email</label>
                    <input class="form-control form-control-sm" name="email" value="{{ selected_user.email|default_if_none:'' }}">
                  </div>
                  <div class="col-md-4">
                    <label class="form-label small text-muted">Status</label>
                    <select class="form-select form-select-sm" name="is_active">
                      <option value="1" {% if selected_user.is_active %}selected{% endif %}>Active</option>
                      <option value="0" {% if not selected_user.is_active %}selected{% endif %}>Closed</option>
                    </select>
                  </div>

                  <div class="col-md-6">
                    <label class="form-label small text-muted">Full name</label>
                    <input class="form-control form-control-sm" name="full_name" value="{{ selected_user.profile.full_name|default_if_none:'' }}">
                  </div>
                  <div class="col-md-6">
                    <label class="form-label small text-muted">Manager</label>
                    <input class="form-control form-control-sm" name="manager" value="{{ selected_user.profile.manager.username|default_if_none:'' }}">
                  </div>

                  <div class="col-md-6">
                    <label class="form-label small text-muted">Cost center</label>
                    <input class="form-control form-control-sm" name="cost_center" value="{{ selected_user.profile.cost_center.code|default_if_none:'' }}">
                  </div>
                  <div class="col-md-6">
                    <label class="form-label small text-muted">Title</label>
                    <input class="form-control form-control-sm" name="title" value="{{ selected_user.profile.title|default_if_none:'' }}">
                  </div>

                  <div class="col-md-6">
                    <label class="form-label small text-muted">Region</label>
                    <input class="form-control form-control-sm" name="region" value="{{ selected_user.profile.region|default_if_none:'' }}">
                  </div>
                  <div class="col-md-6">
                    <label class="form-label small text-muted">Legal entity</label>
                    <input class="form-control form-control-sm" name="legal_entity" value="{{ selected_user.profile.legal_entity|default_if_none:'' }}">
                  </div>

                  <div class="col-md-6">
                    <label class="form-label small text-muted">Location</label>
                    <input class="form-control form-control-sm" name="location" value="{{ selected_user.profile.location|default_if_none:'' }}">
                  </div>
                  <div class="col-md-6">
                    <label class="form-label small text-muted">Phone</label>
                    <input class="form-control form-control-sm" name="phone" value="{{ selected_user.profile.phone|default_if_none:'' }}">
                  </div>
                </div>

                <div class="d-flex justify-content-end gap-2 mt-3">
                  <a class="btn btn-sm btn-ghost"
                     href="?page={{ cp }}&rows={{ rows_per_page|default:50 }}&show_closed={{ sc }}&selected={{ selected_user.id }}#user-details">
                    Discard
                  </a>
                  <button type="submit" class="btn btn-sm dn-btn-primary">
                    Save
                  </button>
                </div>
              </form>
            </div>

            {# RIGHT: Assigned services карта – оставям както беше #}
            <div class="col-12 col-xl-4">
              <div class="portal-card" style="padding:14px;">
                <div class="section-eyebrow mb-1">Services</div>
                <div class="section-title" style="font-size:1.05rem;">Assigned services</div>
                <div class="portal-card-muted mb-2">
                  Each service listed individually with list price.
                </div>

                {% if selected_services %}
                  <div class="d-flex flex-column gap-2">
                    {% for s in selected_services %}
                      <div class="dn-card" style="padding:10px 12px;">
                        <div class="d-flex justify-content-between align-items-start">
                          <div>
                            <div style="font-weight:700; color:var(--dn-strong);">
                              {{ s.service_name }}
                            </div>
                            <div class="small text-muted">
                              {{ s.vendor_name|default:"—" }}
                            </div>
                          </div>
                          <div class="text-end">
                            <div style="font-weight:700;">
                              {{ s.price|default:"—" }}
                              <span class="small text-muted">{{ s.ccy|default:"" }}</span>
                            </div>
                            <div class="small text-muted">
                              {{ s.status|default:"" }}
                            </div>
                          </div>
                        </div>
                      </div>
                    {% endfor %}
                  </div>
                {% else %}
                  <div class="portal-card-muted">
                    No services assigned (or not provided by view yet).
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>

      </div>
    {% else %}
      <div class="portal-card">
        <div class="portal-card-muted mb-0">
          Select a user from the table above to view and edit details inline.
        </div>
      </div>
    {% endif %}
  </div>
</div>

{% endwith %}
{% endwith %}
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener("DOMContentLoaded", function () {
  const detailsTab = document.getElementById('userDetailsTab');
  const auditTab = document.getElementById('userAuditTab');
  const detailsPanel = document.getElementById('userDetailsPanel');
  const auditPanel = document.getElementById('userAuditPanel');

  function activateUserTab(tabName) {
    if (!detailsPanel || !auditPanel || !detailsTab || !auditTab) return;

    const showDetails = tabName === 'details';

    detailsPanel.classList.toggle('d-none', !showDetails);
    auditPanel.classList.toggle('d-none', showDetails);

    if (showDetails) {
      detailsTab.classList.add('active');
      auditTab.classList.remove('active');
    } else {
      auditTab.classList.add('active');
      detailsTab.classList.remove('active');
      auditPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  }

  if (detailsTab && auditTab && detailsPanel && auditPanel) {
    detailsTab.addEventListener('click', function () {
      activateUserTab('details');
    });
    auditTab.addEventListener('click', function () {
      activateUserTab('audit');
    });

    // start always on details
    activateUserTab('details');
  }
});
</script>
{% endblock %}
