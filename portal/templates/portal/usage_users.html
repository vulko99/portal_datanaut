{% extends "portal/base_portal.html" %}
{% load humanize %}
{% load portal_extras %}

{% block title_suffix %} · Usage – User inventory{% endblock %}

{% block content %}
<div class="mb-3">
  <ul class="nav nav-pills nav-sm bg-dark rounded-pill px-1 py-1 d-inline-flex shadow-sm">
    <li class="nav-item">
      <a class="nav-link text-white-50 px-3"
         href="{% url 'portal:usage_invoices' %}">
        Invoice inventory
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link text-white-50 px-3"
         href="{% url 'portal:usage_contract' %}">
        Contract inventory
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link text-white-50 px-3"
         href="{% url 'portal:usage_vendors' %}">
        Vendor inventory
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link active px-3" aria-current="page"
         href="{% url 'portal:usage_users' %}">
        User inventory
      </a>
    </li>
  </ul>
</div>

<div class="portal-card">
  <div class="section-eyebrow mb-1">Dashboards · Users</div>
  <h1 class="section-title mb-1">User inventory</h1>
  <p class="section-subtitle mb-3">
    Users, their assigned services and recent activity. Use this view to identify dormant
    licences and potential savings.
  </p>

  {# KPI ред – същата идея като invoices/vendors #}
  <div class="d-flex flex-wrap gap-3 mb-3 justify-content-between align-items-start">

    <div class="d-flex flex-wrap gap-3">
      <div class="portal-kpi">
        <div class="kpi-label text-muted small">Users in scope</div>
        <div class="kpi-value h4 mb-0">
          {{ total_users }}
        </div>
      </div>

      <div class="portal-kpi">
        <div class="kpi-label text-muted small">Users shown (after filters)</div>
        <div class="kpi-value h4 mb-0">
          {{ filtered_count }}
        </div>
      </div>

      <div class="portal-kpi">
        <div class="kpi-label text-muted small">Dormant users</div>
        <div class="kpi-value h4 mb-0">
          {{ dormant_users_count }}{% if dormant_percent %} ({{ dormant_percent }}%){% endif %}
        </div>
      </div>
    </div>

    <div class="d-flex flex-wrap gap-2 align-items-end">
      <form method="get" class="d-flex flex-wrap gap-2 align-items-end mb-0">

        <div class="me-2">
          <label class="small text-muted text-uppercase mb-1" style="letter-spacing:.08em;">
            Search
          </label>
          <input type="text"
                 name="q"
                 value="{{ q }}"
                 class="form-control form-control-sm"
                 placeholder="User or desk…">
        </div>

        <div class="me-2">
          <label class="small text-muted text-uppercase mb-1" style="letter-spacing:.08em;">
            Status
          </label>
          <select name="status" class="form-select form-select-sm">
            <option value="all" {% if status == "all" %}selected{% endif %}>All statuses</option>
            <option value="active" {% if status == "active" %}selected{% endif %}>Active</option>
            <option value="dormant" {% if status == "dormant" %}selected{% endif %}>Dormant</option>
          </select>
        </div>

        <div class="me-2">
          <label class="small text-muted text-uppercase mb-1" style="letter-spacing:.08em;">
            Rows
          </label>
          <select name="limit" class="form-select form-select-sm">
            {% for size in page_sizes %}
              <option value="{{ size }}" {% if page_size == size %}selected{% endif %}>
                {{ size }}
              </option>
            {% endfor %}
          </select>
        </div>

        <div class="me-3">
          <label class="small text-muted text-uppercase mb-1" style="letter-spacing:.08em;">
            Visibility
          </label>
          <div class="form-check">
            <input class="form-check-input"
                   type="checkbox"
                   id="show-closed"
                   name="show_closed"
                   value="1"
                   {% if show_closed %}checked{% endif %}>
            <label class="form-check-label small text-muted" for="show-closed">
              Include inactive users
            </label>
          </div>
        </div>

        <div class="me-0">
          <button type="submit"
                  class="btn btn-sm btn-primary"
                  style="background:#06b6d4;border-color:#06b6d4;">
            Apply
          </button>
        </div>
      </form>

      {# Export CSV – подравнен до Apply #}
      <a href="?export=csv{% if q %}&q={{ q|urlencode }}{% endif %}{% if status %}&status={{ status }}{% endif %}{% if page_size %}&limit={{ page_size }}{% endif %}{% if show_closed %}&show_closed=1{% endif %}"
         class="btn btn-sm btn-outline-light">
        Export CSV
      </a>
    </div>
  </div>

  {# ТУК е промяната: вътрешен скрол само за таблицата #}
  <div class="table-responsive" style="max-height: 540px; overflow-y: auto;">
    <table class="portal-table align-middle">
      <thead>
        <tr>
          <th style="min-width: 200px;">User</th>
          <th>Desk</th>
          <th class="text-end">Services</th>
          <th class="text-end">Dormant services</th>
          <th>Last login</th>
          <th class="text-end">Status</th>
        </tr>
      </thead>
      <tbody>
        {% for u in user_rows %}
          <tr>
            {# USER #}
            <td>
              <div>
                <a href="{% url 'portal:user_detail' u.user.id %}" class="usage-link">
                  {{ u.username }}
                </a>
              </div>
              <div class="cell-muted small">
                {{ u.services }} services
                {% if u.total_price %}
                  · {{ u.total_price|floatformat:0 }}
                {% endif %}
              </div>
            </td>

            {# DESK #}
            <td class="cell-muted">
              {{ u.desk_label }}
            </td>

            {# SERVICES #}
            <td class="text-end">
              {{ u.services }}
            </td>

            {# DORMANT SERVICES #}
            <td class="text-end">
              {{ u.dormant_services }}
            </td>

            {# LAST LOGIN #}
            <td class="cell-muted">
              {% if u.last_login %}
                {{ u.last_login|date:"Y-m-d" }}
              {% else %}
                No login
              {% endif %}
            </td>

            {# STATUS #}
            <td class="text-end">
              {% if u.status == "Dormant" %}
                <span class="badge badge--warn">Dormant</span>
              {% else %}
                <span class="badge badge--ok">Active</span>
              {% endif %}
            </td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="6" class="cell-muted text-center">
              No users match the current filters.
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="row mt-4 g-3">
    <div class="col-lg-6">
      <h2 class="h6 text-white mb-2">What this view is for</h2>
      <ul class="section-subtitle mb-0">
        <li>Give a single list of users with their licence footprint and recent activity.</li>
        <li>Highlight dormant licences that can be recycled or reallocated.</li>
        <li>Connect individual users back to desks, vendors and invoice spend.</li>
      </ul>
    </div>
    <div class="col-lg-6">
      <h2 class="h6 text-white mb-2">How clients typically use this</h2>
      <ul class="section-subtitle mb-0">
        <li>Run quarterly reviews of dormant users and agree decommissioning plans.</li>
        <li>Export filtered lists for desk heads or application owners to validate.</li>
        <li>Drill into a user to support audit questions or entitlement checks.</li>
      </ul>
    </div>
  </div>
</div>
{% endblock %}
