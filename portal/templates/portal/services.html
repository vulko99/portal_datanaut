{% extends "portal/base_portal.html" %}

{% block title_suffix %} · Services{% endblock %}

{% block content %}
<div class="row g-3">
  <div class="col-12">
    <div class="portal-card">
      <div class="section-header mb-2">
        <div class="section-eyebrow">Inventory</div>
        <h1 class="section-title mb-0">Services</h1>
        <p class="section-subtitle mb-0">
          What each vendor actually sells – data feeds, terminals, analytics, index licences and other services.
          This catalogue links commercial details to contracts and invoices.
        </p>
      </div>

      {# COMPACT HEADER META – като при Vendors #}
      <div class="d-flex flex-wrap align-items-end justify-content-between mt-1 mb-2">
        <div class="small text-muted">
          <span class="me-3">
            Total services: <strong>{{ total_services }}</strong>
          </span>
          <span>
            Showing {{ services|length }} on this page
          </span>
        </div>
        <div class="text-end small text-muted">
          Use the global <strong>Add</strong> button in the top bar to register a new service.
        </div>
      </div>

      {# TOOLBAR: Show closed + Rows – копие от Vendors #}
      <div class="d-flex flex-wrap justify-content-between align-items-center mb-2">
        <div class="d-flex flex-wrap gap-3 align-items-center">

          {# Show closed toggle #}
          <form method="get" class="small d-flex align-items-center gap-3">
            <input type="hidden" name="show_closed" value="0">
            <input type="hidden" name="page" value="{{ current_page|default:1 }}">
            <input type="hidden" name="rows" value="{{ rows_per_page|default:50 }}">
            {% if selected_service %}
              <input type="hidden" name="selected" value="{{ selected_service.id }}">
            {% endif %}

            <div class="form-check form-switch m-0">
              <input class="form-check-input"
                     type="checkbox"
                     id="services-show-closed-toggle"
                     name="show_closed"
                     value="1"
                     {% if show_closed %}checked{% endif %}
                     onchange="this.form.submit()">
              <label class="form-check-label" for="services-show-closed-toggle">
                Show closed
              </label>
            </div>
          </form>

          {# Rows selector #}
          <form method="get" class="small d-flex align-items-center gap-2">
            <input type="hidden" name="page" value="{{ current_page|default:1 }}">
            <input type="hidden" name="show_closed" value="{% if show_closed %}1{% else %}0{% endif %}">
            {% if selected_service %}
              <input type="hidden" name="selected" value="{{ selected_service.id }}">
            {% endif %}

            <span class="text-muted">Rows:</span>
            <select name="rows"
                    class="form-select form-select-sm"
                    style="width:auto; min-width: 90px;"
                    onchange="this.form.submit()">
              {% for opt in rows_options %}
                <option value="{{ opt }}" {% if opt == rows_per_page %}selected{% endif %}>{{ opt }}</option>
              {% endfor %}
            </select>
          </form>

        </div>
      </div>

      {# SERVICE GRID #}
      {% if services %}
        {# Височина като при Vendors – max-height 420px #}
        <div class="table-responsive" style="max-height: 420px; overflow-y: auto;">
          <table class="portal-table align-middle mb-0">
            <thead>
              <tr>
                <th style="width: 20%;">Service</th>
                <th style="width: 16%;">Vendor</th>
                <th style="width: 11%;">Category</th>
                <th style="width: 11%;">Billing</th>
                <th style="width: 8%;">Currency</th>
                <th style="width: 10%; text-align:right;">Price</th>
                <th style="width: 10%;">Split</th>
                <th style="width: 7%;">Owner</th>
                <th style="width: 7%;">Contract</th>
              </tr>
            </thead>
            <tbody>
              {% with sc=show_closed|yesno:"1,0" %}
                {% for service in services %}
                  <tr {% if selected_service and service.id == selected_service.id %}style="background: rgba(20,244,212,.06);"{% endif %}>
                    <td>
                      <a
                        href="?page={{ current_page|default:1 }}&rows={{ rows_per_page|default:50 }}&show_closed={{ sc }}&selected={{ service.id }}#service-details"
                        class="link-table"
                      >
                        {{ service.name }}
                        {% if service.is_active == False %}
                          <span class="badge rounded-pill bg-secondary ms-2">Closed</span>
                        {% endif %}
                      </a>
                    </td>
                    <td class="cell-muted">{{ service.vendor.name }}</td>
                    <td class="cell-muted">{{ service.get_category_display|default:"—" }}</td>
                    <td class="cell-muted">{{ service.get_default_billing_frequency_display|default:"—" }}</td>
                    <td class="cell-muted">{{ service.default_currency|default:"—" }}</td>
                    <td class="cell-muted" style="text-align:right;">
                      {% if service.list_price %}{{ service.list_price }}{% else %}—{% endif %}
                    </td>
                    <td class="cell-muted">{{ service.allocation_split|default:"—" }}</td>
                    <td class="cell-muted">{{ service.owner_display|default:"—" }}</td>
                    <td class="cell-muted">
                      {% if service.primary_contract %}
                        {{ service.primary_contract.contract_name }}
                      {% else %}
                        —
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              {% endwith %}
            </tbody>
          </table>
        </div>

        <p class="portal-card-muted mb-0 mt-2">
          Over time this catalogue can drive licence allocation, renewal bundles and optimisation analysis across desks and cost centres.
        </p>

        {# PAGINATION – копирано от Vendors #}
        {% if page_obj %}
          {% with sc=show_closed|yesno:"1,0" %}
            <nav class="d-flex justify-content-between align-items-center mt-3" aria-label="Services pagination">
              <div class="small text-muted">
                Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
              </div>

              <ul class="pagination pagination-sm mb-0">
                <li class="page-item {% if not page_obj.has_previous %}disabled{% endif %}">
                  {% if page_obj.has_previous %}
                    <a class="page-link"
                       href="?page={{ page_obj.previous_page_number }}&rows={{ rows_per_page }}&show_closed={{ sc }}{% if selected_service %}&selected={{ selected_service.id }}{% endif %}">
                      Prev
                    </a>
                  {% else %}
                    <span class="page-link">Prev</span>
                  {% endif %}
                </li>

                {% for p in page_obj.paginator.page_range %}
                  {% if p == 1 or p == page_obj.paginator.num_pages or p >= page_obj.number|add:-2 and p <= page_obj.number|add:2 %}
                    <li class="page-item {% if p == page_obj.number %}active{% endif %}">
                      <a class="page-link"
                         href="?page={{ p }}&rows={{ rows_per_page }}&show_closed={{ sc }}{% if selected_service %}&selected={{ selected_service.id }}{% endif %}">
                        {{ p }}
                      </a>
                    </li>
                  {% endif %}
                {% endfor %}

                <li class="page-item {% if not page_obj.has_next %}disabled{% endif %}">
                  {% if page_obj.has_next %}
                    <a class="page-link"
                       href="?page={{ page_obj.next_page_number }}&rows={{ rows_per_page }}&show_closed={{ sc }}{% if selected_service %}&selected={{ selected_service.id }}{% endif %}">
                      Next
                    </a>
                  {% else %}
                    <span class="page-link">Next</span>
                  {% endif %}
                </li>
              </ul>
            </nav>
          {% endwith %}
        {% endif %}

      {% else %}
        <p class="portal-card-muted mb-0">
          No services yet. Once you add services to vendors (via this portal or admin), they will appear here.
        </p>
      {% endif %}
    </div>
  </div>

  {# INLINE SERVICE DETAILS + AUDIT #}
  <div class="col-12" id="service-details">
    {% if selected_service %}
      <div class="portal-card">
        <div class="d-flex justify-content-between align-items-start mb-2">
          <div class="flex-grow-1">
            <div class="d-flex align-items-center gap-2 mb-2">
              <button id="serviceDetailsTab"
                      type="button"
                      class="btn btn-sm btn-ghost">
                Service details
              </button>
              <button id="serviceAuditTab"
                      type="button"
                      class="btn btn-sm btn-ghost">
                Audit · Change log
              </button>
            </div>
            <div class="section-title mb-0">{{ selected_service.name }}</div>
            <div class="section-subtitle mb-0">
              {{ selected_service.vendor.name }}{% if selected_service.category %} · {{ selected_service.get_category_display }}{% endif %}
            </div>
          </div>
          <div class="small text-muted text-end">
            Make changes below and <strong>Save</strong>.
          </div>
        </div>

        {# AUDIT PANEL (shown when Audit tab is active) #}
        <div class="mb-3 d-none" id="serviceAuditPanel">
          <div class="portal-card" style="padding: 14px;">
            <div class="section-eyebrow mb-1">Audit</div>
            <div class="section-title" style="font-size: 1.05rem;">Change log</div>
            <div class="portal-card-muted mb-2">
              Latest changes for this service.
            </div>

            {% if audit_events %}
              <div class="table-responsive" style="max-height: 260px; overflow-y: auto;">
                <table class="portal-table align-middle mb-0">
                  <thead>
                    <tr>
                      <th style="width: 22%;">When</th>
                      <th style="width: 18%;">Actor</th>
                      <th style="width: 60%;">Change</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for ev in audit_events %}
                      <tr>
                        <td class="cell-muted">
                          {% if ev.created_at %}
                            {{ ev.created_at|date:"Y-m-d H:i" }}
                          {% elif ev.timestamp %}
                            {{ ev.timestamp|date:"Y-m-d H:i" }}
                          {% elif ev.created %}
                            {{ ev.created|date:"Y-m-d H:i" }}
                          {% elif ev.history_date %}
                            {{ ev.history_date|date:"Y-m-d H:i" }}
                          {% elif ev.occurred_at %}
                            {{ ev.occurred_at|date:"Y-m-d H:i" }}
                          {% elif ev.when %}
                            {{ ev.when }}
                          {% elif ev.changed_at %}
                            {{ ev.changed_at }}
                          {% elif ev.updated_at %}
                            {{ ev.updated_at }}
                          {% else %}
                            —
                          {% endif %}
                        </td>
                        <td class="cell-muted">
                          {% if ev.actor_display %}
                            {{ ev.actor_display }}
                          {% elif ev.actor %}
                            {{ ev.actor }}
                          {% else %}
                            —
                          {% endif %}
                        </td>
                        <td class="cell-muted">
                          {% if ev.description %}
                            {{ ev.description }}
                          {% elif ev.action %}
                            {{ ev.action|capfirst }}
                          {% else %}
                            —
                          {% endif %}
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <div class="portal-card-muted">No audit events yet.</div>
            {% endif %}
          </div>
        </div>

        {# SERVICE DETAILS PANEL (shown when Service details tab is active) #}
        <div id="serviceDetailsPanel">
          <form method="post">
            {% csrf_token %}

            <input type="hidden" name="action" value="update_selected">
            <input type="hidden" name="selected" value="{{ selected_service.id }}">
            <input type="hidden" name="page" value="{{ current_page|default:1 }}">
            <input type="hidden" name="rows" value="{{ rows_per_page|default:50 }}">
            <input type="hidden" name="show_closed" value="{% if show_closed %}1{% else %}0{% endif %}">

            <div class="row g-3">

              <div class="col-md-4">
                <label class="form-label small text-muted">Service name</label>
                <input class="form-control form-control-sm" name="name" value="{{ selected_service.name|default_if_none:'' }}">
              </div>

              <div class="col-md-4">
                <label class="form-label small text-muted">Vendor</label>
                <select class="form-select form-select-sm" name="vendor_id">
                  {% for v in vendors %}
                    <option value="{{ v.id }}" {% if selected_service.vendor_id == v.id %}selected{% endif %}>
                      {{ v.name }}
                    </option>
                  {% endfor %}
                </select>
              </div>

              <div class="col-md-4">
                <label class="form-label small text-muted">Status</label>
                <select class="form-select form-select-sm" name="is_active">
                  <option value="1" {% if selected_service.is_active %}selected{% endif %}>Active</option>
                  <option value="0" {% if not selected_service.is_active %}selected{% endif %}>Closed</option>
                </select>
              </div>

              <div class="col-md-4">
                <label class="form-label small text-muted">Category</label>
                <select class="form-select form-select-sm" name="category">
                  <option value="">Select…</option>
                  <option value="data_feed" {% if selected_service.category == "data_feed" %}selected{% endif %}>Data feed</option>
                  <option value="terminal" {% if selected_service.category == "terminal" %}selected{% endif %}>Terminal</option>
                  <option value="analytics" {% if selected_service.category == "analytics" %}selected{% endif %}>Analytics</option>
                  <option value="index_license" {% if selected_service.category == "index_license" %}selected{% endif %}>Index license</option>
                  <option value="connectivity" {% if selected_service.category == "connectivity" %}selected{% endif %}>Connectivity</option>
                  <option value="other" {% if selected_service.category == "other" %}selected{% endif %}>Other</option>
                </select>
              </div>

              <div class="col-md-4">
                <label class="form-label small text-muted">Billing frequency</label>
                <select class="form-select form-select-sm" name="billing_frequency">
                  <option value="">Select…</option>
                  <option value="monthly" {% if selected_service.default_billing_frequency == "monthly" %}selected{% endif %}>Monthly</option>
                  <option value="quarterly" {% if selected_service.default_billing_frequency == "quarterly" %}selected{% endif %}>Quarterly</option>
                  <option value="yearly" {% if selected_service.default_billing_frequency == "yearly" %}selected{% endif %}>Yearly</option>
                </select>
              </div>

              <div class="col-md-4">
                <label class="form-label small text-muted">Default currency</label>
                <input class="form-control form-control-sm" name="default_currency" value="{{ selected_service.default_currency|default_if_none:'' }}">
              </div>

              <div class="col-md-4">
                <label class="form-label small text-muted">Service code / SKU</label>
                <input class="form-control form-control-sm" name="service_code" value="{{ selected_service.service_code|default_if_none:'' }}">
              </div>

              <div class="col-md-4">
                <label class="form-label small text-muted">Price (annual / unit)</label>
                <input class="form-control form-control-sm" name="list_price" value="{{ selected_service.list_price|default_if_none:'' }}">
              </div>

              <div class="col-md-4">
                <label class="form-label small text-muted">Allocation split</label>
                <input class="form-control form-control-sm" name="allocation_split" value="{{ selected_service.allocation_split|default_if_none:'' }}">
              </div>

              <div class="col-md-6">
                <label class="form-label small text-muted">Service owner</label>
                <input class="form-control form-control-sm" name="owner_display" value="{{ selected_service.owner_display|default_if_none:'' }}">
              </div>

              <div class="col-md-6">
                <label class="form-label small text-muted">Primary contract</label>
                <input class="form-control form-control-sm"
                       name="primary_contract_id"
                       value="{% if selected_service.primary_contract_id %}{{ selected_service.primary_contract_id }}{% endif %}"
                       placeholder="Contract ID (optional)">
                <div class="small text-muted mt-1">
                  Matches contract by ID (for now).
                </div>
              </div>

            </div>

            <div class="d-flex justify-content-end gap-2 mt-3">
              {% with sc=show_closed|yesno:"1,0" %}
                <a class="btn btn-sm btn-ghost"
                   href="?page={{ current_page|default:1 }}&rows={{ rows_per_page|default:50 }}&show_closed={{ sc }}&selected={{ selected_service.id }}#service-details">
                  Discard
                </a>
              {% endwith %}
              <button type="submit" class="btn btn-sm dn-btn-primary">
                Save
              </button>
            </div>
          </form>
        </div>
      </div>
    {% else %}
      <div class="portal-card">
        <div class="portal-card-muted mb-0">
          Select a service from the table above to view and edit details inline.
        </div>
      </div>
    {% endif %}
  </div>
</div>

{# ADD SERVICE MODAL (оставям както е) #}
<div class="modal fade" id="addServiceModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content"
         style="background:#020617; border-radius:18px; border:1px solid rgba(148,163,184,.35); color:#E5E7EB;">
      <div class="modal-header border-0" style="border-bottom-color:rgba(148,163,184,.25);">
        <div>
          <h5 class="modal-title">Add new service</h5>
          <div class="small text-muted">
            Register a service with its commercial details, owner and primary contract.
          </div>
        </div>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body pb-4">
        <form method="post">
          {% csrf_token %}
          <input type="hidden" name="action" value="create">

          <div class="row g-3 small">
            <div class="col-md-5">
              <label class="form-label form-label-sm mb-1">Service name</label>
              <input type="text" name="name" class="form-control form-control-sm"
                     placeholder="e.g. Real-time FX feed"
                     value="{{ add_form_data.name|default:'' }}">
            </div>
            <div class="col-md-4">
              <label class="form-label form-label-sm mb-1">Vendor</label>
              <select name="vendor_id" class="form-select form-select-sm">
                <option value="">Select vendor…</option>
                {% for vendor in vendors %}
                  <option value="{{ vendor.id }}"
                    {% if add_form_data.vendor_id == vendor.id|stringformat:"s" %}selected{% endif %}>
                    {{ vendor.name }}
                  </option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label form-label-sm mb-1">Service code / SKU</label>
              <input type="text" name="service_code" class="form-control form-control-sm"
                     placeholder="Vendor product code"
                     value="{{ add_form_data.service_code|default:'' }}">
            </div>

            <div class="col-md-4">
              <label class="form-label form-label-sm mb-1">Category</label>
              <select class="form-select form-select-sm" name="category">
                <option value="">Select…</option>
                <option value="data_feed" {% if add_form_data.category == "data_feed" %}selected{% endif %}>Data feed</option>
                <option value="terminal" {% if add_form_data.category == "terminal" %}selected{% endif %}>Terminal</option>
                <option value="analytics" {% if add_form_data.category == "analytics" %}selected{% endif %}>Analytics</option>
                <option value="index_license" {% if add_form_data.category == "index_license" %}selected{% endif %}>Index license</option>
                <option value="connectivity" {% if add_form_data.category == "connectivity" %}selected{% endif %}>Connectivity</option>
                <option value="other" {% if add_form_data.category == "other" %}selected{% endif %}>Other</option>
              </select>
            </div>

            <div class="col-md-4">
              <label class="form-label form-label-sm mb-1">Billing frequency</label>
              <select class="form-select form-select-sm" name="billing_frequency">
                <option value="">Select…</option>
                <option value="monthly" {% if add_form_data.billing_frequency == "monthly" %}selected{% endif %}>Monthly</option>
                <option value="quarterly" {% if add_form_data.billing_frequency == "quarterly" %}selected{% endif %}>Quarterly</option>
                <option value="yearly" {% if add_form_data.billing_frequency == "yearly" %}selected{% endif %}>Yearly</option>
              </select>
            </div>

            <div class="col-md-4">
              <label class="form-label form-label-sm mb-1">Default currency</label>
              <input type="text" name="default_currency" class="form-control form-control-sm"
                     placeholder="e.g. USD, EUR, CHF"
                     value="{{ add_form_data.default_currency|default:'' }}">
            </div>

            <div class="col-md-4">
              <label class="form-label form-label-sm mb-1">Price (annual / unit)</label>
              <input type="number" step="0.01" name="list_price"
                     class="form-control form-control-sm" placeholder="e.g. 120000"
                     value="{{ add_form_data.list_price|default:'' }}">
            </div>

            <div class="col-md-4">
              <label class="form-label form-label-sm mb-1">Allocation split</label>
              <input type="text" name="allocation_split"
                     class="form-control form-control-sm"
                     placeholder="e.g. 60% Trading / 40% Research"
                     value="{{ add_form_data.allocation_split|default:'' }}">
            </div>

            <div class="col-md-4">
              <label class="form-label form-label-sm mb-1">Service owner</label>
              <input type="text" name="service_owner"
                     class="form-control form-control-sm"
                     placeholder="Name / team (business owner)"
                     value="{{ add_form_data.owner_display|default:'' }}">
            </div>

            <div class="col-md-6">
              <label class="form-label form-label-sm mb-1">Primary contract</label>
              <input type="text" name="contract_ref"
                     class="form-control form-control-sm"
                     placeholder="Contract name or ID (optional)"
                     value="{{ add_form_data.contract_ref|default:'' }}">
              <div class="form-text text-muted small">
                Matches contract name, vendor contract ID or internal ID for the selected vendor.
              </div>
            </div>
          </div>

          <div class="d-flex justify-content-end gap-2 mt-3">
            <button type="button" class="btn btn-ghost btn-sm" data-bs-dismiss="modal">
              Cancel
            </button>
            <button type="submit" class="btn btn-add btn-sm">
              Save and close
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
(function () {
  const globalAddBtn = document.getElementById('globalAddButton');
  const addServiceModalEl = document.getElementById('addServiceModal');

  if (globalAddBtn && addServiceModalEl && window.bootstrap) {
    const modalInstance = new bootstrap.Modal(addServiceModalEl);
    globalAddBtn.addEventListener('click', function () {
      modalInstance.show();
    });
  }

  const hasErrors = document.querySelector('#addServiceModal .errorlist') !== null;
  if (hasErrors && addServiceModalEl && window.bootstrap) {
    const modal = new bootstrap.Modal(addServiceModalEl);
    modal.show();
  }

  // Tabs inside Service details: Service details vs Audit
  const detailsTab = document.getElementById('serviceDetailsTab');
  const auditTab = document.getElementById('serviceAuditTab');
  const detailsPanel = document.getElementById('serviceDetailsPanel');
  const auditPanel = document.getElementById('serviceAuditPanel');

  function activateServiceTab(tabName) {
    if (!detailsPanel || !auditPanel || !detailsTab || !auditTab) return;

    const showDetails = tabName === 'details';

    // Toggle panels
    detailsPanel.classList.toggle('d-none', !showDetails);
    auditPanel.classList.toggle('d-none', showDetails);

    // Visual state for tabs
    if (showDetails) {
      detailsTab.classList.add('active');
      auditTab.classList.remove('active');
    } else {
      auditTab.classList.add('active');
      detailsTab.classList.remove('active');
      // Scroll audit panel into view for better UX
      auditPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  }

  if (detailsTab && auditTab && detailsPanel && auditPanel) {
    detailsTab.addEventListener('click', function () {
      activateServiceTab('details');
    });
    auditTab.addEventListener('click', function () {
      activateServiceTab('audit');
    });

    // Initial state – always land on Service details
    activateServiceTab('details');
  }
})();
</script>
{% endblock %}
