{% extends "portal/base_portal.html" %}

{% block title_suffix %} · Services{% endblock %}

{% block content %}
<div class="row g-3">
    <div class="col-12">
        <div class="portal-card">
            <div class="section-header mb-2">
                <div class="section-eyebrow">Inventory</div>
                <h1 class="section-title mb-0">Services</h1>
                <p class="section-subtitle mb-0">
                    What each vendor actually sells – data feeds, terminals, analytics, index licences and other services.
                    This catalogue links commercial details to contracts and invoices.
                </p>
            </div>

            <div class="d-flex flex-wrap align-items-center justify-content-between mt-1 mb-3">
                <div class="d-flex flex-wrap gap-3">
                    <div>
                        <div class="metric-label">Total services</div>
                        <div class="metric-value">
                            {{ services|length }}
                        </div>
                    </div>
                </div>
                <div class="text-end small portal-card-muted">
                    Use the <strong>Add</strong> button in the top bar to register a new service.
                </div>
            </div>

            <!-- TOOLBAR: search + filters -->
            <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
                <div class="d-flex flex-wrap gap-2">
                    <div class="input-group input-group-sm" style="max-width: 320px;">
                        <span class="input-group-text text-uppercase fw-semibold" style="font-size: 0.7rem;">
                            Search
                        </span>
                        <input
                            type="search"
                            id="serviceSearch"
                            class="form-control"
                            placeholder="Service, vendor, owner, contract…">
                    </div>

                    <select id="vendorFilter" class="form-select form-select-sm" style="min-width: 180px;">
                        <option value="">All vendors</option>
                    </select>

                    <select id="categoryFilter" class="form-select form-select-sm" style="min-width: 180px;">
                        <option value="">All categories</option>
                        <option value="data_feed">Data feed</option>
                        <option value="terminal">Terminal</option>
                        <option value="analytics">Analytics</option>
                        <option value="index_license">Index license</option>
                        <option value="connectivity">Connectivity</option>
                        <option value="other">Other</option>
                    </select>
                </div>
            </div>

            <!-- SERVICE GRID -->
            {% if services %}
                <div class="table-responsive">
                    <table class="portal-table align-middle">
                        <thead>
                            <tr>
                                <th style="width: 20%;">Service</th>
                                <th style="width: 16%;">Vendor</th>
                                <th style="width: 11%;">Category</th>
                                <th style="width: 11%;">Billing</th>
                                <th style="width: 8%;">Currency</th>
                                <th style="width: 10%; text-align:right;">Price</th>
                                <th style="width: 10%;">Split</th>
                                <th style="width: 7%;">Owner</th>
                                <th style="width: 7%;">Contract</th>
                            </tr>
                        </thead>
                        <tbody id="servicesTableBody">
                            {% for service in services %}
                                <tr
                                    data-service-name="{{ service.name|default_if_none:'' }}"
                                    data-vendor="{{ service.vendor.name|default_if_none:'' }}"
                                    data-category="{{ service.category|default_if_none:'' }}"
                                    data-owner="{{ service.owner_display|default_if_none:'' }}"
                                    data-contract="{% if service.primary_contract %}{{ service.primary_contract.contract_name }}{% endif %}"
                                >
                                    <td>
                                        <a href="{% url 'portal:service_detail' service.pk %}" class="link-inline">
                                            {{ service.name }}
                                        </a>
                                    </td>
                                    <td class="cell-muted">{{ service.vendor.name }}</td>
                                    <td class="cell-muted">
                                        {{ service.get_category_display|default:"—" }}
                                    </td>
                                    <td class="cell-muted">
                                        {{ service.get_default_billing_frequency_display|default:"—" }}
                                    </td>
                                    <td class="cell-muted">
                                        {{ service.default_currency|default:"—" }}
                                    </td>
                                    <td class="cell-muted" style="text-align:right;">
                                        {% if service.list_price %}
                                            {{ service.list_price }}
                                        {% else %}
                                            —
                                        {% endif %}
                                    </td>
                                    <td class="cell-muted">
                                        {{ service.allocation_split|default:"—" }}
                                    </td>
                                    <td class="cell-muted">
                                        {{ service.owner_display|default:"—" }}
                                    </td>
                                    <td class="cell-muted">
                                        {% if service.primary_contract %}
                                            {{ service.primary_contract.contract_name }}
                                        {% else %}
                                            —
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <p class="portal-card-muted mb-0 mt-2">
                    Over time this catalogue can drive licence allocation, renewal bundles and optimisation analysis across desks and cost centres.
                </p>
            {% else %}
                <div class="empty d-flex flex-wrap align-items-center justify-content-between">
                    <div>
                        No services yet. Once you add services to vendors (via this portal or admin), they will appear here.
                    </div>
                    <div class="mt-2 mt-sm-0">
                        <button type="button"
                                class="btn btn-add btn-sm"
                                data-bs-toggle="modal"
                                data-bs-target="#addServiceModal">
                            + Add service
                        </button>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- ADD SERVICE MODAL -->
<div class="modal fade" id="addServiceModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content"
             style="background:#020617; border-radius:18px; border:1px solid rgba(148,163,184,.35); color:#E5E7EB;">
            <div class="modal-header border-0" style="border-bottom-color:rgba(148,163,184,.25);">
                <div>
                    <h5 class="modal-title">Add new service</h5>
                    <div class="small text-muted">
                        Register a service with its commercial details, owner and primary contract.
                    </div>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body pb-4">
                <form method="post">
                    {% csrf_token %}
                    <div class="row g-3 small">
                        <div class="col-md-5">
                            <label class="form-label form-label-sm mb-1">Service name</label>
                            <input type="text" name="name" class="form-control form-control-sm"
                                   placeholder="e.g. Real-time FX feed"
                                   value="{{ add_form_data.name|default:'' }}">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label form-label-sm mb-1">Vendor</label>
                            <select name="vendor_id" class="form-select form-select-sm">
                                <option value="">Select vendor…</option>
                                {% for vendor in vendors %}
                                    <option value="{{ vendor.id }}"
                                        {% if add_form_data.vendor_id == vendor.id|stringformat:"s" %}selected{% endif %}>
                                        {{ vendor.name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label form-label-sm mb-1">Service code / SKU</label>
                            <input type="text" name="service_code" class="form-control form-control-sm"
                                   placeholder="Vendor product code"
                                   value="{{ add_form_data.service_code|default:'' }}">
                        </div>

                        <div class="col-md-4">
                            <label class="form-label form-label-sm mb-1">Category</label>
                            <select class="form-select form-select-sm" name="category">
                                <option value="">Select…</option>
                                <option value="data_feed" {% if add_form_data.category == "data_feed" %}selected{% endif %}>Data feed</option>
                                <option value="terminal" {% if add_form_data.category == "terminal" %}selected{% endif %}>Terminal</option>
                                <option value="analytics" {% if add_form_data.category == "analytics" %}selected{% endif %}>Analytics</option>
                                <option value="index_license" {% if add_form_data.category == "index_license" %}selected{% endif %}>Index license</option>
                                <option value="connectivity" {% if add_form_data.category == "connectivity" %}selected{% endif %}>Connectivity</option>
                                <option value="other" {% if add_form_data.category == "other" %}selected{% endif %}>Other</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label form-label-sm mb-1">Billing frequency</label>
                            <select class="form-select form-select-sm" name="billing_frequency">
                                <option value="">Select…</option>
                                <option value="monthly" {% if add_form_data.billing_frequency == "monthly" %}selected{% endif %}>Monthly</option>
                                <option value="quarterly" {% if add_form_data.billing_frequency == "quarterly" %}selected{% endif %}>Quarterly</option>
                                <option value="yearly" {% if add_form_data.billing_frequency == "yearly" %}selected{% endif %}>Yearly</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label form-label-sm mb-1">Default currency</label>
                            <input type="text" name="default_currency" class="form-control form-control-sm"
                                   placeholder="e.g. USD, EUR, CHF"
                                   value="{{ add_form_data.default_currency|default:'' }}">
                        </div>

                        <div class="col-md-4">
                            <label class="form-label form-label-sm mb-1">Price (annual / unit)</label>
                            <input type="number" step="0.01" name="list_price"
                                   class="form-control form-control-sm" placeholder="e.g. 120000"
                                   value="{{ add_form_data.list_price|default:'' }}">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label form-label-sm mb-1">Allocation split</label>
                            <input type="text" name="allocation_split"
                                   class="form-control form-control-sm"
                                   placeholder="e.g. 60% Trading / 40% Research"
                                   value="{{ add_form_data.allocation_split|default:'' }}">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label form-label-sm mb-1">Service owner</label>
                            <input type="text" name="service_owner"
                                   class="form-control form-control-sm"
                                   placeholder="Name / team (business owner)"
                                   value="{{ add_form_data.owner_display|default:'' }}">
                        </div>

                        <div class="col-md-6">
                            <label class="form-label form-label-sm mb-1">Primary contract</label>
                            <input type="text" name="contract_ref"
                                   class="form-control form-control-sm"
                                   placeholder="Contract name or ID (optional)"
                                   value="{{ add_form_data.contract_ref|default:'' }}">
                            <div class="form-text text-muted small">
                                Matches contract name, vendor contract ID or internal ID for the selected vendor.
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-end gap-2 mt-3">
                        <button type="button" class="btn btn-ghost btn-sm" data-bs-dismiss="modal">
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-add btn-sm">
                            Save and close
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
(function () {
    const searchInput = document.getElementById('serviceSearch');
    const vendorSelect = document.getElementById('vendorFilter');
    const categorySelect = document.getElementById('categoryFilter');
    const tableBody = document.getElementById('servicesTableBody');
    const globalAddBtn = document.getElementById('globalAddButton');
    const addServiceModalEl = document.getElementById('addServiceModal');
    const addServiceModal =
        addServiceModalEl && window.bootstrap
            ? new bootstrap.Modal(addServiceModalEl)
            : null;

    let rows = [];
    const vendors = new Set();

    if (tableBody) {
        rows = Array.from(tableBody.querySelectorAll('tr'));

        // populate vendor filter from table rows
        rows.forEach(row => {
            const v = (row.dataset.vendor || '').trim();
            if (v) vendors.add(v);
        });

        if (vendorSelect) {
            Array.from(vendors).sort().forEach(v => {
                const opt = document.createElement('option');
                opt.value = v;
                opt.textContent = v;
                vendorSelect.appendChild(opt);
            });
        }

        function applyFilters() {
            const query = (searchInput ? searchInput.value : '').toLowerCase();
            const vendorFilter = vendorSelect ? vendorSelect.value.toLowerCase() : '';
            const categoryFilter = categorySelect ? categorySelect.value : '';

            rows.forEach(row => {
                const serviceName = (row.dataset.serviceName || '').toLowerCase();
                const vendor = (row.dataset.vendor || '').toLowerCase();
                const owner = (row.dataset.owner || '').toLowerCase();
                const contract = (row.dataset.contract || '').toLowerCase();
                const category = (row.dataset.category || '');
                const fullText = (row.textContent || '').toLowerCase();

                const matchesText =
                    !query ||
                    serviceName.includes(query) ||
                    vendor.includes(query) ||
                    owner.includes(query) ||
                    contract.includes(query) ||
                    fullText.includes(query);

                const matchesVendor =
                    !vendorFilter || vendor === vendorFilter;

                const matchesCategory =
                    !categoryFilter || category === categoryFilter;

                row.style.display = (matchesText && matchesVendor && matchesCategory) ? '' : 'none';
            });
        }

        if (searchInput) {
            searchInput.addEventListener('input', applyFilters);
        }
        if (vendorSelect) {
            vendorSelect.addEventListener('change', applyFilters);
        }
        if (categorySelect) {
            categorySelect.addEventListener('change', applyFilters);
        }
    }

    // Global "Add" button in topbar -> open this page's service modal
    if (globalAddBtn && addServiceModal) {
        globalAddBtn.addEventListener('click', function () {
            addServiceModal.show();
        });
    }

    // If POST returned errors – auto-open modal for corrections
    const addFormHasErrors = JSON.parse('{{ add_form_has_errors|yesno:"true,false"|default:"false"|escapejs }}');
    if (addFormHasErrors && addServiceModal) {
        addServiceModal.show();
    }
})();
</script>
{% endblock %}
