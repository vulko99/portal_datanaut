{% extends "portal/base_portal.html" %}

{% block title_suffix %} · Contracts{% endblock %}

{% block content %}
<div class="row g-3">
    <div class="col-12">
        <div class="portal-card">
            <div class="section-header mb-2">
                <div class="section-eyebrow">Inventory</div>
                <h1 class="section-title mb-0">Contracts</h1>
                <p class="section-subtitle mb-0">
                    Signed agreements with vendors. Use this view to upload new contracts and track renewal dates.
                </p>
            </div>

            <div class="d-flex flex-wrap align-items-center justify-content-between mt-1 mb-3">
                <div class="d-flex flex-wrap gap-3">
                    <div>
                        <div class="metric-label">Total contracts</div>
                        <div class="metric-value">
                            {{ contracts|length }}
                        </div>
                    </div>
                </div>
                <div class="text-end small portal-card-muted">
                    Use the <strong>Add</strong> button in the top bar to upload a new contract.
                </div>
            </div>

            {# TOOLBAR: search + filters #}
            {% if contracts %}
                <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
                    <div class="d-flex flex-wrap gap-2">
                        <div class="input-group input-group-sm" style="max-width: 320px;">
                            <span class="input-group-text text-uppercase fw-semibold" style="font-size: 0.7rem;">
                                Search
                            </span>
                            <input
                                type="search"
                                id="contractSearch"
                                class="form-control"
                                placeholder="Contract, vendor, ID…">
                        </div>

                        <select id="contractVendorFilter" class="form-select form-select-sm" style="min-width: 180px;">
                            <option value="">All vendors</option>
                        </select>

                        <select id="contractStatusFilter" class="form-select form-select-sm" style="min-width: 160px;">
                            <option value="">All statuses</option>
                        </select>
                    </div>
                </div>
            {% endif %}

            {% if contracts %}
                <div class="table-responsive">
                    <table class="portal-table align-middle">
                        <thead>
                        <tr>
                            <th style="width: 20%;">Contract</th>
                            <th style="width: 18%;">Vendor</th>
                            <th style="width: 12%;">Type</th>
                            <th style="width: 10%;">Currency</th>
                            <th style="width: 12%; text-align:right;">Annual value</th>
                            <th style="width: 12%;">Start</th>
                            <th style="width: 12%;">End</th>
                            <th style="width: 12%;">Renewal</th>
                        </tr>
                        </thead>
                        <tbody id="contractsTableBody">
                        {% for c in contracts %}
                            <tr
                                data-contract-name="{{ c.contract_name|default_if_none:'' }}"
                                data-vendor="{{ c.vendor.name|default_if_none:'' }}"
                                data-status="{{ c.status|default_if_none:'' }}"
                            >
                                <td>
                                    <a href="{% url 'portal:contract_detail' c.pk %}" class="link-inline">
                                        {{ c.contract_name }}
                                    </a>
                                    {% if c.contract_id %}
                                        <div class="cell-muted small">Vendor ID: {{ c.contract_id }}</div>
                                    {% endif %}
                                </td>
                                <td class="cell-muted">{{ c.vendor.name }}</td>
                                <td class="cell-muted">{{ c.get_contract_type_display|default:"—" }}</td>
                                <td class="cell-muted">{{ c.currency|default:"—" }}</td>
                                <td class="cell-muted" style="text-align:right;">
                                    {% if c.annual_value %}{{ c.annual_value }}{% else %}—{% endif %}
                                </td>
                                <td class="cell-muted">
                                    {% if c.start_date %}{{ c.start_date }}{% else %}—{% endif %}
                                </td>
                                <td class="cell-muted">
                                    {% if c.end_date %}{{ c.end_date }}{% else %}—{% endif %}
                                </td>
                                <td class="cell-muted">
                                    {% if c.renewal_date %}{{ c.renewal_date }}{% else %}—{% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>

                <p class="portal-card-muted mt-2 mb-0">
                    In a full deployment this grid can be extended with contract owners, renewal alerts, linked
                    cost centres and workflow status.
                </p>
            {% else %}
                <div class="empty d-flex flex-wrap align-items-center justify-content-between">
                    <div>
                        No contracts yet for this user. Use the
                        <span class="fw-semibold">Add</span> button in the top bar to upload signed agreements.
                    </div>
                    <div class="mt-2 mt-sm-0">
                        <button type="button"
                                class="btn btn-add btn-sm"
                                data-bs-toggle="modal"
                                data-bs-target="#addContractModal">
                            + Add contract
                        </button>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

{# --------- ADD CONTRACT MODAL --------- #}
<div class="modal fade" id="addContractModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content" style="background: rgba(10,15,25,.96); color:#E5E7EB; border-radius:18px; border:1px solid rgba(148,163,184,.4);">
            <div class="modal-header border-0 pt-3 pb-1 px-4">
                <div>
                    <h5 class="modal-title">Add contract</h5>
                    <div class="small text-muted">
                        Upload a signed contract and capture key metadata (term, value, renewal).
                    </div>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body px-4 pb-4">
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    {{ form.non_field_errors }}

                    <div class="row g-3 mb-3">
                        <div class="col-md-6 col-xl-4">
                            {{ form.vendor.label_tag }}
                            {{ form.vendor }}
                            {{ form.vendor.errors }}
                        </div>
                        <div class="col-md-6 col-xl-4">
                            {{ form.contract_name.label_tag }}
                            {{ form.contract_name }}
                            {{ form.contract_name.errors }}
                        </div>
                        <div class="col-md-6 col-xl-4">
                            {{ form.contract_id.label_tag }}
                            {{ form.contract_id }}
                            {{ form.contract_id.errors }}
                        </div>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-md-6 col-xl-4">
                            {{ form.contract_type.label_tag }}
                            {{ form.contract_type }}
                            {{ form.contract_type.errors }}
                        </div>
                        <div class="col-md-6 col-xl-4">
                            {{ form.entity.label_tag }}
                            {{ form.entity }}
                            {{ form.entity.errors }}
                        </div>
                        <div class="col-md-6 col-xl-2">
                            {{ form.annual_value.label_tag }}
                            {{ form.annual_value }}
                            {{ form.annual_value.errors }}
                        </div>
                        <div class="col-md-6 col-xl-2">
                            {{ form.currency.label_tag }}
                            {{ form.currency }}
                            {{ form.currency.errors }}
                        </div>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-md-6 col-xl-4">
                            {{ form.start_date.label_tag }}
                            {{ form.start_date }}
                            {{ form.start_date.errors }}
                        </div>
                        <div class="col-md-6 col-xl-4">
                            {{ form.end_date.label_tag }}
                            {{ form.end_date }}
                            {{ form.end_date.errors }}
                        </div>
                        <div class="col-md-6 col-xl-4">
                            {{ form.renewal_date.label_tag }}
                            {{ form.renewal_date }}
                            {{ form.renewal_date.errors }}
                        </div>
                    </div>

                    {# Notice fields #}
                    <div class="row g-3 mb-3">
                        <div class="col-md-6 col-xl-4">
                            {{ form.notice_period_days.label_tag }}
                            {{ form.notice_period_days }}
                            {{ form.notice_period_days.errors }}
                            <div class="form-text text-muted">
                                Optional. If set and Notice date is empty, the system will derive it from End date.
                            </div>
                        </div>
                        <div class="col-md-6 col-xl-4">
                            {{ form.notice_date.label_tag }}
                            {{ form.notice_date }}
                            {{ form.notice_date.errors }}
                            <div class="form-text text-muted">
                                Optional manual override (must be on/before End date).
                            </div>
                        </div>
                        <div class="col-xl-4 d-none d-xl-block"></div>
                    </div>

                    <div class="row g-3 mb-2">
                        <div class="col-md-12 col-xl-6">
                            {{ form.file.label_tag }}
                            {{ form.file }}
                            {{ form.file.errors }}
                        </div>
                    </div>

                    <div class="d-flex justify-content-end gap-2 mt-3">
                        <button type="button" class="btn btn-ghost btn-sm" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-add btn-sm">Save and close</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
(function () {
    const tableBody = document.getElementById('contractsTableBody');
    const searchInput = document.getElementById('contractSearch');
    const vendorSelect = document.getElementById('contractVendorFilter');
    const statusSelect = document.getElementById('contractStatusFilter');
    const globalAddBtn = document.getElementById('globalAddButton');
    const modalEl = document.getElementById('addContractModal');
    const modal =
        modalEl && window.bootstrap
            ? new bootstrap.Modal(modalEl)
            : null;

    let rows = [];
    const vendors = new Set();
    const statuses = new Set();

    if (tableBody) {
        rows = Array.from(tableBody.querySelectorAll('tr'));

        // Populate filters from existing rows
        rows.forEach(row => {
            const v = (row.dataset.vendor || '').trim();
            const s = (row.dataset.status || '').trim();
            if (v) vendors.add(v);
            if (s) statuses.add(s);
        });

        if (vendorSelect) {
            Array.from(vendors).sort().forEach(v => {
                const opt = document.createElement('option');
                opt.value = v;
                opt.textContent = v;
                vendorSelect.appendChild(opt);
            });
        }

        if (statusSelect) {
            Array.from(statuses).sort().forEach(s => {
                const opt = document.createElement('option');
                opt.value = s;
                opt.textContent = s;
                statusSelect.appendChild(opt);
            });
        }

        function applyFilters() {
            const query = (searchInput ? searchInput.value : '').toLowerCase();
            const vendorFilter = vendorSelect ? vendorSelect.value.toLowerCase() : '';
            const statusFilter = statusSelect ? statusSelect.value.toLowerCase() : '';

            rows.forEach(row => {
                const contractName = (row.dataset.contractName || '').toLowerCase();
                const vendor = (row.dataset.vendor || '').toLowerCase();
                const status = (row.dataset.status || '').toLowerCase();
                const fullText = (row.textContent || '').toLowerCase();

                const matchesText =
                    !query ||
                    contractName.includes(query) ||
                    vendor.includes(query) ||
                    fullText.includes(query);

                const matchesVendor =
                    !vendorFilter || vendor === vendorFilter;

                const matchesStatus =
                    !statusFilter || status === statusFilter;

                row.style.display = (matchesText && matchesVendor && matchesStatus) ? '' : 'none';
            });
        }

        if (searchInput) {
            searchInput.addEventListener('input', applyFilters);
        }
        if (vendorSelect) {
            vendorSelect.addEventListener('change', applyFilters);
        }
        if (statusSelect) {
            statusSelect.addEventListener('change', applyFilters);
        }
    }

    // Global "Add" button in topbar -> open this page's contract modal
    if (globalAddBtn && modal) {
        globalAddBtn.addEventListener('click', function () {
            modal.show();
        });
    }

    // Auto-open modal if the POSTed form returned errors
    const hasErrors = document.querySelector('#addContractModal .errorlist') !== null;
    if (hasErrors && modal) {
        modal.show();
    }
})();
</script>
{% endblock %}
