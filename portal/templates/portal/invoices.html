{% extends "portal/base_portal.html" %}

{% block title_suffix %} · Invoices{% endblock %}

{% block content %}
<div class="row g-3">
    <div class="col-12">
        <div class="portal-card">
            <div class="section-header mb-2">
                <div class="section-eyebrow">Invoicing</div>
                <h1 class="section-title mb-0">Invoices</h1>
                <p class="section-subtitle mb-0">
                    Upload invoices to keep a record of billed amounts and link them to contracts.
                </p>
            </div>

            <div class="d-flex flex-wrap align-items-center justify-content-between mt-1 mb-3">
                <div class="d-flex flex-wrap gap-3">
                    <div>
                        <div class="metric-label">Total invoices</div>
                        <div class="metric-value">
                            {{ invoices|length }}
                        </div>
                    </div>
                    <div>
                        <div class="metric-label">Total amount</div>
                        <div class="metric-value">
                            {% if total_amount %}{{ total_amount }}{% else %}—{% endif %}
                        </div>
                    </div>
                </div>
                <div class="text-end small portal-card-muted">
                    Use the <strong>Add</strong> button in the top bar to upload a new invoice.
                </div>
            </div>

            {# TOOLBAR: search + filters + rows/Showing #}
            {% if invoices %}
                <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
                    <div class="d-flex flex-wrap gap-2">
                        <div class="input-group input-group-sm" style="max-width: 320px;">
                            <span class="input-group-text text-uppercase fw-semibold" style="font-size: 0.7rem;">
                                Search
                            </span>
                            <input
                                type="search"
                                id="invoiceSearch"
                                class="form-control"
                                placeholder="Invoice, vendor, contract…">
                        </div>

                        <select id="invoiceVendorFilter" class="form-select form-select-sm" style="min-width: 180px;">
                            <option value="">All vendors</option>
                        </select>

                        <select id="invoiceContractFilter" class="form-select form-select-sm" style="min-width: 180px;">
                            <option value="">All contracts</option>
                        </select>

                        <select id="invoiceCurrencyFilter" class="form-select form-select-sm" style="min-width: 120px;">
                            <option value="">All currencies</option>
                        </select>
                    </div>

                    <div class="d-flex flex-wrap align-items-center gap-2 small mt-2 mt-md-0">
                        <span id="invoiceShowingLabel">
                            Showing {{ invoices|length }} of {{ invoices|length }} invoices
                        </span>
                        <span class="ms-1">Rows:</span>
                        <select id="invoiceRowsPerPage" class="form-select form-select-sm" style="width:auto; min-width: 80px;">
                            <option value="25">25</option>
                            <option value="50" selected>50</option>
                            <option value="100">100</option>
                            <option value="250">250</option>
                            <option value="all">All</option>
                        </select>
                    </div>
                </div>
            {% endif %}

            {% if invoices %}
                <div class="table-responsive" style="max-height: 540px; overflow-y: auto;">
                    <table class="portal-table align-middle">
                        <thead>
                        <tr>
                            <th style="width: 18%;">Invoice</th>
                            <th style="width: 18%;">Vendor</th>
                            <th style="width: 14%;">Contract</th>
                            <th style="width: 10%;">Date</th>
                            <th style="width: 8%;">Currency</th>
                            <th style="width: 12%; text-align:right;">Total</th>
                            <th style="width: 8%;">Tax</th>
                            <th style="width: 12%;">Period</th>
                        </tr>
                        </thead>
                        <tbody id="invoicesTableBody">
                        {% for i in invoices %}
                            <tr
                                data-invoice-number="{{ i.invoice_number|default_if_none:'' }}"
                                data-vendor="{{ i.vendor.name|default_if_none:'' }}"
                                data-contract="{% if i.contract %}{{ i.contract.contract_name }}{% endif %}"
                                data-currency="{{ i.currency|default_if_none:'' }}"
                            >
                                <td>
                                    <a href="{% url 'portal:invoice_detail' i.pk %}" class="link-table">
                                        {{ i.invoice_number }}
                                    </a>
                                    {% if i.file %}
                                        <div class="cell-muted small">
                                            <a href="{{ i.file.url }}" target="_blank" rel="noopener" class="link-inline">
                                                PDF
                                            </a>
                                        </div>
                                    {% endif %}
                                </td>
                                <td class="cell-muted">{{ i.vendor.name }}</td>
                                <td class="cell-muted">
                                    {% if i.contract %}
                                        {{ i.contract.contract_name }}
                                    {% else %}
                                        —
                                    {% endif %}
                                </td>
                                <td class="cell-muted">{{ i.invoice_date }}</td>
                                <td class="cell-muted">{{ i.currency }}</td>
                                <td class="cell-muted" style="text-align:right;">{{ i.total_amount }}</td>
                                <td class="cell-muted">
                                    {% if i.tax_amount %}{{ i.tax_amount }}{% else %}—{% endif %}
                                </td>
                                <td class="cell-muted">
                                    {% if i.period_start and i.period_end %}
                                        {{ i.period_start }} → {{ i.period_end }}
                                    {% elif i.period_start %}
                                        From {{ i.period_start }}
                                    {% elif i.period_end %}
                                        Until {{ i.period_end }}
                                    {% else %}
                                        —
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>

                <p class="portal-card-muted mt-2 mb-0">
                    Over time you can extend this grid with invoice status, payment date, cost centre splits and
                    links back to the contract record.
                </p>
            {% else %}
                <div class="empty d-flex flex-wrap align-items-center justify-content-between">
                    <div>
                        No invoices yet for this user. Use the
                        <span class="fw-semibold">Add</span> button in the top bar to upload invoice PDFs.
                    </div>
                    <div class="mt-2 mt-sm-0">
                        <button type="button"
                                class="btn btn-add btn-sm"
                                data-bs-toggle="modal"
                                data-bs-target="#addInvoiceModal">
                            + Add invoice
                        </button>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

{# Modal за качване на Invoice – активира се от глобалния Add бутон #}
<div class="modal fade" id="addInvoiceModal" tabindex="-1" aria-labelledby="addInvoiceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content" style="background: rgba(10,15,25,.96); color:#E5E7EB; border-radius:18px; border:1px solid rgba(148,163,184,.4);">
            <div class="modal-header border-0 pt-3 pb-1 px-4">
                <div>
                    <h5 class="modal-title" id="addInvoiceModalLabel">Add invoice</h5>
                    <div class="small text-muted">
                        Upload invoice header details and the PDF. Line-level splits can be added later.
                    </div>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body px-4 pb-4">
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    {{ form.non_field_errors }}

                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            {{ form.vendor.label_tag }}
                            {{ form.vendor }}
                            {{ form.vendor.errors }}
                        </div>
                        <div class="col-md-6">
                            {{ form.contract.label_tag }}
                            {{ form.contract }}
                            {{ form.contract.errors }}
                        </div>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-md-4">
                            {{ form.invoice_number.label_tag }}
                            {{ form.invoice_number }}
                            {{ form.invoice_number.errors }}
                        </div>
                        <div class="col-md-4">
                            {{ form.invoice_date.label_tag }}
                            {{ form.invoice_date }}
                            {{ form.invoice_date.errors }}
                        </div>
                        <div class="col-md-4">
                            {{ form.currency.label_tag }}
                            {{ form.currency }}
                            {{ form.currency.errors }}
                        </div>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-md-4">
                            {{ form.total_amount.label_tag }}
                            {{ form.total_amount }}
                            {{ form.total_amount.errors }}
                        </div>
                        <div class="col-md-4">
                            {{ form.tax_amount.label_tag }}
                            {{ form.tax_amount }}
                            {{ form.tax_amount.errors }}
                        </div>
                        <div class="col-md-4">
                            {{ form.file.label_tag }}
                            {{ form.file }}
                            {{ form.file.errors }}
                        </div>
                    </div>

                    <div class="row g-3 mb-2">
                        <div class="col-md-6">
                            {{ form.period_start.label_tag }}
                            {{ form.period_start }}
                            {{ form.period_start.errors }}
                        </div>
                        <div class="col-md-6">
                            {{ form.period_end.label_tag }}
                            {{ form.period_end }}
                            {{ form.period_end.errors }}
                        </div>
                    </div>

                    <div class="d-flex justify-content-end gap-2 mt-3">
                        <button type="button" class="btn btn-ghost btn-sm" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-add btn-sm">Save and close</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
(function () {
    const tableBody = document.getElementById('invoicesTableBody');
    const searchInput = document.getElementById('invoiceSearch');
    const vendorSelect = document.getElementById('invoiceVendorFilter');
    const contractSelect = document.getElementById('invoiceContractFilter');
    const currencySelect = document.getElementById('invoiceCurrencyFilter');
    const rowsSelect = document.getElementById('invoiceRowsPerPage');
    const showingLabel = document.getElementById('invoiceShowingLabel');

    const globalAddBtn = document.getElementById('globalAddButton');
    const modalEl = document.getElementById('addInvoiceModal');
    const modal =
        modalEl && window.bootstrap
            ? new bootstrap.Modal(modalEl)
            : null;

    let rows = [];
    const vendors = new Set();
    const contracts = new Set();
    const currencies = new Set();

    if (tableBody) {
        rows = Array.from(tableBody.querySelectorAll('tr'));

        // Попълваме филтрите от наличните редове
        rows.forEach(row => {
            const v = (row.dataset.vendor || '').trim();
            const c = (row.dataset.contract || '').trim();
            const cur = (row.dataset.currency || '').trim();
            if (v) vendors.add(v);
            if (c) contracts.add(c);
            if (cur) currencies.add(cur);
        });

        if (vendorSelect) {
            Array.from(vendors).sort().forEach(v => {
                const opt = document.createElement('option');
                opt.value = v;
                opt.textContent = v;
                vendorSelect.appendChild(opt);
            });
        }

        if (contractSelect) {
            Array.from(contracts).sort().forEach(c => {
                const opt = document.createElement('option');
                opt.value = c;
                opt.textContent = c;
                contractSelect.appendChild(opt);
            });
        }

        if (currencySelect) {
            Array.from(currencies).sort().forEach(cur => {
                const opt = document.createElement('option');
                opt.value = cur;
                opt.textContent = cur;
                currencySelect.appendChild(opt);
            });
        }

        function applyFilters() {
            const query = (searchInput ? searchInput.value : '').toLowerCase();
            const vendorFilter = vendorSelect ? vendorSelect.value.toLowerCase() : '';
            const contractFilter = contractSelect ? contractSelect.value.toLowerCase() : '';
            const currencyFilter = currencySelect ? currencySelect.value.toLowerCase() : '';

            let limit = Infinity;
            if (rowsSelect && rowsSelect.value && rowsSelect.value !== 'all') {
                const parsed = parseInt(rowsSelect.value, 10);
                if (!isNaN(parsed) && parsed > 0) {
                    limit = parsed;
                }
            }

            let totalMatching = 0;
            let shown = 0;

            rows.forEach(row => {
                const invoiceNumber = (row.dataset.invoiceNumber || '').toLowerCase();
                const vendor = (row.dataset.vendor || '').toLowerCase();
                const contract = (row.dataset.contract || '').toLowerCase();
                const currency = (row.dataset.currency || '').toLowerCase();
                const fullText = (row.textContent || '').toLowerCase();

                const matchesText =
                    !query ||
                    invoiceNumber.includes(query) ||
                    vendor.includes(query) ||
                    contract.includes(query) ||
                    fullText.includes(query);

                const matchesVendor =
                    !vendorFilter || vendor === vendorFilter;

                const matchesContract =
                    !contractFilter || contract === contractFilter;

                const matchesCurrency =
                    !currencyFilter || currency === currencyFilter;

                const matches =
                    matchesText && matchesVendor && matchesContract && matchesCurrency;

                if (!matches) {
                    row.style.display = 'none';
                    return;
                }

                totalMatching += 1;

                if (shown < limit) {
                    row.style.display = '';
                    shown += 1;
                } else {
                    row.style.display = 'none';
                }
            });

            if (showingLabel) {
                if (totalMatching === 0) {
                    showingLabel.textContent = 'Showing 0 of 0 invoices';
                } else {
                    showingLabel.textContent = `Showing ${shown} of ${totalMatching} invoices`;
                }
            }
        }

        if (searchInput) {
            searchInput.addEventListener('input', applyFilters);
        }
        if (vendorSelect) {
            vendorSelect.addEventListener('change', applyFilters);
        }
        if (contractSelect) {
            contractSelect.addEventListener('change', applyFilters);
        }
        if (currencySelect) {
            currencySelect.addEventListener('change', applyFilters);
        }
        if (rowsSelect) {
            rowsSelect.addEventListener('change', applyFilters);
        }

        // първоначално изчисление
        applyFilters();
    }

    // Глобалният Add бутон в topbar -> отваря този invoice modal
    if (globalAddBtn && modal) {
        globalAddBtn.addEventListener('click', function () {
            modal.show();
        });
    }

    // Auto-open modal ако POST-натата форма е върнала грешки
    const hasErrors = document.querySelector('#addInvoiceModal .errorlist') !== null;
    if (hasErrors && modal) {
        modal.show();
    }
})();
</script>
{% endblock %}
