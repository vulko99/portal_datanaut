{% extends "portal/base_portal.html" %}

{% block title_suffix %} · Invoicing{% endblock %}

{% block content %}
<div class="row g-3">
    <div class="col-12">
        <div class="portal-card">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <div class="section-eyebrow mb-1">Inventory</div>
                    <h1 class="section-title mb-1">Invoicing</h1>
                    <p class="section-subtitle mb-0">
                        Invoice list (number, date, amount, currency). In a full deployment this view feeds your
                        spend analytics, budget vs. actuals and GL reconciliations.
                    </p>
                </div>
                <div class="text-end portal-card-muted small">
                    <div>Total invoices: <span class="fw-semibold">{{ invoices|length }}</span></div>
                    <div>
                        Total amount:
                        <span class="fw-semibold">
                            {{ total_amount|default:"0.00" }}
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Филтри + таблица -->
    <div class="col-12">
        <div class="portal-card">
            <form method="get" class="row g-2 align-items-end mb-3">
                <div class="col-md-6 col-lg-5">
                    <label class="form-label text-uppercase text-muted mb-1"
                           style="font-size:.72rem; letter-spacing:.12em;">
                        Search
                    </label>
                    <input type="text"
                           name="q"
                           class="form-control form-control-sm"
                           placeholder="Invoice №, vendor, contract..."
                           value="{{ filter_q }}">
                </div>
                <div class="col-md-3 col-lg-3">
                    <label class="form-label text-uppercase text-muted mb-1"
                           style="font-size:.72rem; letter-spacing:.12em;">
                        Year
                    </label>
                    <select name="year" class="form-select form-select-sm">
                        <option value="">All years</option>
                        {% for y in year_choices %}
                            <option value="{{ y }}" {% if filter_year|stringformat:'s' == y|stringformat:'s' %}selected{% endif %}>
                                {{ y }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3 col-lg-2 d-flex gap-2">
                    <button type="submit" class="btn btn-ghost btn-sm w-100">
                        Apply
                    </button>
                    <a href="{% url 'portal:invoices' %}" class="btn btn-outline-secondary btn-sm w-100">
                        Reset
                    </a>
                </div>
            </form>

            {% if invoices %}
                <div class="table-responsive">
                    <table class="portal-table align-middle">
                        <thead>
                            <tr>
                                <th style="width:18%;">Invoice №</th>
                                <th style="width:14%;">Invoice date</th>
                                <th style="width:22%;">Vendor</th>
                                <th style="width:22%;">Contract</th>
                                <th style="width:14%;">Amount</th>
                                <th style="width:10%;">Currency</th>
                                <th style="width:10%;">Document</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for i in invoices %}
                                <tr>
                                    <td>
                                        <a href="{% url 'portal:invoice_detail' i.pk %}" class="link-inline">
                                            <strong>{{ i.invoice_number }}</strong>
                                        </a>
                                    </td>
                                    <td class="cell-muted">
                                        {{ i.invoice_date }}
                                    </td>
                                    <td class="cell-muted">
                                        <a href="{% url 'portal:vendor_detail' i.vendor.pk %}" class="link-inline">
                                            {{ i.vendor.name }}
                                        </a>
                                    </td>
                                    <td class="cell-muted">
                                        {% if i.contract %}
                                            <a href="{% url 'portal:contract_detail' i.contract.pk %}" class="link-inline">
                                                {{ i.contract.contract_name }}
                                            </a>
                                        {% else %}
                                            —
                                        {% endif %}
                                    </td>
                                    <td class="cell-muted text-end">
                                        {{ i.total_amount }}
                                    </td>
                                    <td class="cell-muted">
                                        {{ i.currency }}
                                    </td>
                                    <td class="cell-muted">
                                        <a href="{% url 'portal:invoice_detail' i.pk %}" class="link-inline">
                                            Open
                                        </a>
                                        {% if i.file %}
                                            <span class="cell-muted">·</span>
                                            <a href="{{ i.file.url }}" target="_blank" rel="noopener" class="link-inline">
                                                PDF
                                            </a>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <p class="portal-card-muted mt-2 mb-0">
                    Over time you can extend this grid with invoice status, payment date, cost centre splits and
                    links back to the contract record.
                </p>
            {% else %}
                <div class="empty">
                    No invoices yet for this user. Use the global
                    <span class="fw-semibold">Add</span> button in the top bar to upload invoice PDFs.
                </div>
            {% endif %}
        </div>
    </div>
</div>

{# Modal за качване на Invoice – активира се от глобалния Add бутон #}
<div class="modal fade" id="addInvoiceModal" tabindex="-1" aria-labelledby="addInvoiceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content" style="background: rgba(10,15,25,.96); color:#E5E7EB; border-radius:18px; border:1px solid rgba(148,163,184,.4);">
            <div class="modal-header border-0 pt-3 pb-1 px-4">
                <div>
                    <h5 class="modal-title" id="addInvoiceModalLabel">Add invoice</h5>
                    <div class="small text-muted">
                        Upload invoice header details and the PDF. Line-level splits can be added later.
                    </div>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body px-4 pb-4">
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    {{ form.non_field_errors }}

                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            {{ form.vendor.label_tag }}
                            {{ form.vendor }}
                        </div>
                        <div class="col-md-6">
                            {{ form.contract.label_tag }}
                            {{ form.contract }}
                        </div>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-md-4">
                            {{ form.invoice_number.label_tag }}
                            {{ form.invoice_number }}
                        </div>
                        <div class="col-md-4">
                            {{ form.invoice_date.label_tag }}
                            {{ form.invoice_date }}
                        </div>
                        <div class="col-md-4">
                            {{ form.currency.label_tag }}
                            {{ form.currency }}
                        </div>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-md-4">
                            {{ form.total_amount.label_tag }}
                            {{ form.total_amount }}
                        </div>
                        <div class="col-md-4">
                            {{ form.tax_amount.label_tag }}
                            {{ form.tax_amount }}
                        </div>
                        <div class="col-md-4">
                            {{ form.file.label_tag }}
                            {{ form.file }}
                        </div>
                    </div>

                    <div class="row g-3 mb-2">
                        <div class="col-md-6">
                            {{ form.period_start.label_tag }}
                            {{ form.period_start }}
                        </div>
                        <div class="col-md-6">
                            {{ form.period_end.label_tag }}
                            {{ form.period_end }}
                        </div>
                    </div>

                    <div class="d-flex justify-content-end gap-2 mt-3">
                        <button type="button" class="btn btn-ghost btn-sm" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-add btn-sm">Save and close</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}
