{% extends "portal/base_portal.html" %}

{% block title_suffix %} · Service · {{ service.name }}{% endblock %}

{% block content %}
<div class="row g-3">

    <!-- HEADER -->
    <div class="col-12">
        <div class="portal-card">
            <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
                <div>
                    <div class="section-eyebrow mb-1">Services · Detail</div>
                    <h1 class="section-title mb-1">
                        {{ service.name }}

                        {# OPTIONAL: Closed badge (matches Vendor pattern) #}
                        {% if service.is_active is not None and not service.is_active %}
                            <span class="badge rounded-pill bg-secondary ms-2">Closed</span>
                        {% endif %}
                    </h1>
                    <p class="section-subtitle mb-0">
                        Vendor:
                        <a href="{% url 'portal:vendor_detail' service.vendor.pk %}" class="link-inline">
                            {{ service.vendor.name }}
                        </a>
                        {% if service.category %} · {{ service.category }}{% endif %}
                    </p>
                </div>

                <div class="text-end">
                    <div class="metric-label mb-1">Primary contract</div>
                    <div class="metric-value" style="font-size:1rem;">
                        {% if service.primary_contract %}
                            <a href="{% url 'portal:contract_detail' service.primary_contract.pk %}"
                               class="link-inline">
                                {{ service.primary_contract.contract_name }}
                            </a>
                        {% else %}
                            —
                        {% endif %}
                    </div>
                    <div class="portal-card-muted small mt-2">
                        Billing:
                        {{ service.default_billing_frequency|default:"—" }}<br>
                        Currency:
                        {{ service.default_currency|default:"—" }}
                    </div>

                    <div class="d-flex justify-content-end flex-wrap gap-2 mt-3">
                        <a href="{% url 'portal:services' %}" class="btn btn-ghost btn-sm">
                            Back to services
                        </a>

                        <!-- Audit log button (Vendor-style) -->
                        <button type="button" id="service-audit-btn"
                                class="btn btn-ghost btn-sm">
                            Audit log
                        </button>

                        <button type="button" id="service-cancel-btn"
                                class="btn btn-ghost btn-sm d-none">
                            Cancel
                        </button>

                        <button type="button" id="service-edit-btn"
                                class="btn btn-add btn-sm">
                            Edit
                        </button>

                        <button type="button" id="service-delete-open"
                                class="btn btn-ghost btn-sm">
                            Delete
                        </button>
                    </div>
                </div>
            </div>

            <!-- NEW: Collapsible Audit Log Panel (Vendor-style) -->
            <div id="service-audit-panel" class="d-none mt-3">
                <div class="portal-card" style="padding: 0; background: transparent; border: none;">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <h6 class="mb-0">Audit log</h6>
                            <div class="portal-card-muted small">
                                Changes made to this service record (who/when/what).
                            </div>
                        </div>
                        <button type="button" id="service-audit-close"
                                class="btn btn-ghost btn-sm" aria-label="Close audit log">
                            ✕
                        </button>
                    </div>

                    <div class="table-responsive">
                        <table class="portal-table align-middle">
                            <thead>
                            <tr>
                                <th style="width: 120px;">Date</th>
                                <th style="width: 90px;">Time</th>
                                <th style="width: 110px;">Action</th>
                                <th style="width: 180px;">User</th>
                                <th>Change description</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% if audit_events %}
                                {% for ev in audit_events %}
                                    <tr>
                                        <td class="cell-muted">
                                            {% if ev.occurred_at %}{{ ev.occurred_at|date:"M. d, Y" }}{% else %}—{% endif %}
                                        </td>
                                        <td class="cell-muted">
                                            {% if ev.occurred_at %}{{ ev.occurred_at|date:"H:i" }}{% else %}—{% endif %}
                                        </td>
                                        <td class="cell-muted">
                                            {% if ev.action %}
                                                {{ ev.action|capfirst }}
                                            {% else %}
                                                —
                                            {% endif %}
                                        </td>
                                        <td class="cell-muted">
                                            {% if ev.actor_display %}
                                                {{ ev.actor_display }}
                                            {% elif ev.actor %}
                                                {{ ev.actor }}
                                            {% else %}
                                                —
                                            {% endif %}
                                        </td>
                                        <td class="cell-muted">
                                            {{ ev.description|default:"—" }}
                                        </td>
                                    </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="5" class="cell-muted">
                                        No audit events yet.
                                    </td>
                                </tr>
                            {% endif %}
                            </tbody>
                        </table>
                    </div>

                    {% if audit_has_more %}
                        <div class="portal-card-muted small mt-2">
                            Showing latest events. Load more is available in the next iteration.
                        </div>
                    {% endif %}
                </div>
            </div>

        </div>
    </div>

    <!-- LEFT: VIEW MODE -->
    <div class="col-lg-7" id="service-view-mode">
        <div class="portal-card h-100">
            <div class="d-flex justify-content-between align-items-start gap-3 mb-2 flex-wrap">
                <div>
                    <h6 class="mb-1">Service detail</h6>
                    <p class="portal-card-muted mb-0">
                        Core attributes of this service.
                    </p>
                </div>

                <!-- STATUS TOGGLE (like Vendor: inside the details card, top-right) -->
                {% if service.is_active is not None %}
                <form method="post" class="small">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="update_status">

                    {# default: Active (is_active=1). If checkbox is checked, override to 0 (Closed). #}
                    <input type="hidden" name="is_active" value="1">

                    <div class="form-check form-switch m-0">
                        <input class="form-check-input"
                               type="checkbox"
                               id="service-closed-toggle"
                               name="is_active"
                               value="0"
                               {% if service.is_active is not None and not service.is_active %}checked{% endif %}
                               onchange="this.form.submit()">
                        <label class="form-check-label" for="service-closed-toggle">
                            Closed
                        </label>
                    </div>
                    <div class="portal-card-muted" style="font-size: .8rem; margin-top: .15rem;">
                        Turn on to mark service as Closed.
                    </div>
                </form>
                {% endif %}
            </div>

            <div class="row gy-3">
                <div class="col-sm-6">
                    <div class="metric-label mb-1">Service name</div>
                    <div>{{ service.name }}</div>
                </div>
                <div class="col-sm-6">
                    <div class="metric-label mb-1">Vendor</div>
                    <div>{{ service.vendor.name }}</div>
                </div>

                <div class="col-sm-6">
                    <div class="metric-label mb-1">Category</div>
                    <div>{{ service.category|default:"—" }}</div>
                </div>
                <div class="col-sm-6">
                    <div class="metric-label mb-1">Billing frequency</div>
                    <div>{{ service.default_billing_frequency|default:"—" }}</div>
                </div>

                <div class="col-sm-6">
                    <div class="metric-label mb-1">Default currency</div>
                    <div>{{ service.default_currency|default:"—" }}</div>
                </div>
                <div class="col-sm-6">
                    <div class="metric-label mb-1">Service code / SKU</div>
                    <div>{{ service.service_code|default:"—" }}</div>
                </div>

                <div class="col-sm-6">
                    <div class="metric-label mb-1">Owner</div>
                    <div>{{ service.owner_display|default:"—" }}</div>
                </div>
                <div class="col-sm-6">
                    <div class="metric-label mb-1">Primary contract</div>
                    <div>
                        {% if service.primary_contract %}
                            <a href="{% url 'portal:contract_detail' service.primary_contract.pk %}"
                               class="link-inline">
                                {{ service.primary_contract.contract_name }}
                            </a>
                        {% else %}
                            —
                        {% endif %}
                    </div>
                </div>

                <div class="col-sm-6">
                    <div class="metric-label mb-1">List price</div>
                    <div>
                        {% if service.list_price %}
                            {{ service.list_price }}
                        {% else %}
                            —
                        {% endif %}
                    </div>
                </div>
                <div class="col-sm-6">
                    <div class="metric-label mb-1">Allocation split</div>
                    <div>{{ service.allocation_split|default:"—" }}</div>
                </div>
            </div>
        </div>
    </div>

    <!-- LEFT: EDIT MODE -->
    <div class="col-lg-7 d-none" id="service-edit-mode">
        <form method="post">
            {% csrf_token %}
            <input type="hidden" name="action" value="update">
            <div class="portal-card h-100">
                <h6 class="mb-2">Service detail</h6>
                <p class="portal-card-muted mb-3">
                    Update the core attributes of this service. Use Save changes to apply.
                </p>

                <div class="row g-3 small">
                    <div class="col-md-6">
                        <label class="form-label form-label-sm">Service name</label>
                        <input type="text" name="name" class="form-control form-control-sm"
                               value="{{ service.name }}">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label form-label-sm">Vendor</label>
                        <select name="vendor_id" class="form-select form-select-sm">
                            <option value="">---------</option>
                            {% for v in vendors %}
                                <option value="{{ v.pk }}" {% if v.pk == service.vendor_id %}selected{% endif %}>
                                    {{ v.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label form-label-sm">Category</label>
                        <input type="text" name="category" class="form-control form-control-sm"
                               value="{{ service.category }}">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label form-label-sm">Billing frequency</label>
                        <input type="text" name="billing_frequency" class="form-control form-control-sm"
                               value="{{ service.default_billing_frequency }}">
                    </div>

                    <div class="col-md-6">
                        <label class="form-label form-label-sm">Default currency</label>
                        <input type="text" name="default_currency" class="form-control form-control-sm"
                               value="{{ service.default_currency }}">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label form-label-sm">Service code / SKU</label>
                        <input type="text" name="service_code" class="form-control form-control-sm"
                               value="{{ service.service_code }}">
                    </div>

                    <div class="col-md-6">
                        <label class="form-label form-label-sm">Owner</label>
                        <input type="text" name="owner_display" class="form-control form-control-sm"
                               value="{{ service.owner_display }}">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label form-label-sm">Primary contract</label>
                        <select name="primary_contract_id" class="form-select form-select-sm">
                            <option value="">---------</option>
                            {% for c in contracts %}
                                <option value="{{ c.pk }}"
                                    {% if service.primary_contract_id == c.pk %}selected{% endif %}>
                                    {{ c.contract_name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label form-label-sm">List price</label>
                        <input type="text" name="list_price" class="form-control form-control-sm"
                               value="{{ service.list_price|default_if_none:'' }}">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label form-label-sm">Allocation split</label>
                        <input type="text" name="allocation_split" class="form-control form-control-sm"
                               value="{{ service.allocation_split }}">
                    </div>
                </div>

                <div class="d-flex justify-content-end gap-2 mt-3">
                    <button type="submit" class="btn btn-add btn-sm">
                        Save changes
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- RIGHT: RELATED CONTRACTS / INVOICE LINES -->
    <div class="col-lg-5 d-flex flex-column gap-3">
        <div class="portal-card">
            <h6 class="mb-2">Contracts linked to this service</h6>
            {% if related_contracts %}
                <ul class="mb-0 small">
                    {% for c in related_contracts %}
                        <li>
                            <a href="{% url 'portal:contract_detail' c.pk %}" class="link-inline">
                                {{ c.contract_name }}
                            </a>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p class="portal-card-muted mb-0">No contracts linked to this service yet.</p>
            {% endif %}
        </div>

        <div class="portal-card">
            <h6 class="mb-2">Recent invoice lines</h6>
            {% if invoice_lines %}
                <div class="table-responsive">
                    <table class="portal-table align-middle">
                        <thead>
                        <tr>
                            <th>Invoice</th>
                            <th>Date</th>
                            <th class="text-end">Amount</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for line in invoice_lines %}
                            <tr>
                                <td class="cell-muted">
                                    <a href="{% url 'portal:invoice_detail' line.invoice.pk %}" class="link-inline">
                                        {{ line.invoice.invoice_number }}
                                    </a>
                                </td>
                                <td class="cell-muted">
                                    {% if line.invoice.invoice_date %}
                                        {{ line.invoice.invoice_date|date:"M. d, Y" }}
                                    {% else %}—{% endif %}
                                </td>
                                <td class="cell-muted text-end">
                                    {{ line.line_amount }}
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="portal-card-muted mb-0">No invoice lines mapped to this service.</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- DELETE MODAL -->
<div id="service-delete-backdrop" class="portal-modal-backdrop d-none">
    <div class="portal-modal-card">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="mb-0">Delete service</h6>
            <button type="button" class="btn btn-ghost btn-sm delete-service-cancel" aria-label="Close">
                ✕
            </button>
        </div>
        <p class="mb-2">
            Are you sure you want to delete service <strong>{{ service.name }}</strong>?
        </p>
        <p class="portal-card-muted mb-4">
            This action cannot be undone.
        </p>

        <form method="post" id="service-delete-form">
            {% csrf_token %}
            <input type="hidden" name="action" value="delete">
            <div class="d-flex justify-content-end gap-2">
                <button type="button" class="btn btn-ghost btn-sm delete-service-cancel">
                    Cancel
                </button>
                <button type="submit" class="btn btn-danger btn-sm">
                    Delete
                </button>
            </div>
        </form>
    </div>
</div>

<style>
.portal-modal-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(3, 6, 23, 0.85);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1100;
}

.portal-modal-card {
    background: #050816;
    border-radius: 12px;
    padding: 1.5rem 1.75rem;
    max-width: 520px;
    width: 100%;
    box-shadow: 0 24px 80px rgba(0, 0, 0, 0.65);
}

/* Optional: make audit panel feel native */
#service-audit-panel {
    border-top: 1px solid rgba(255,255,255,0.06);
    padding-top: 1rem;
}
</style>

<script>
(function () {
    const viewMode = document.getElementById("service-view-mode");
    const editMode = document.getElementById("service-edit-mode");
    const editBtn = document.getElementById("service-edit-btn");
    const cancelBtn = document.getElementById("service-cancel-btn");

    if (editBtn && viewMode && editMode && cancelBtn) {
        editBtn.addEventListener("click", function () {
            viewMode.classList.add("d-none");
            editMode.classList.remove("d-none");
            editBtn.classList.add("d-none");
            cancelBtn.classList.remove("d-none");
        });

        cancelBtn.addEventListener("click", function () {
            window.location.reload();
        });
    }

    // Audit panel toggle (Vendor-style)
    const auditBtn = document.getElementById("service-audit-btn");
    const auditPanel = document.getElementById("service-audit-panel");
    const auditClose = document.getElementById("service-audit-close");

    if (auditBtn && auditPanel) {
        auditBtn.addEventListener("click", function () {
            auditPanel.classList.toggle("d-none");
        });
    }
    if (auditClose && auditPanel) {
        auditClose.addEventListener("click", function () {
            auditPanel.classList.add("d-none");
        });
    }

    const openDeleteBtn = document.getElementById("service-delete-open");
    const backdrop = document.getElementById("service-delete-backdrop");
    const cancelDeleteBtns = document.querySelectorAll(".delete-service-cancel");

    if (openDeleteBtn && backdrop) {
        openDeleteBtn.addEventListener("click", function () {
            backdrop.classList.remove("d-none");
        });

        cancelDeleteBtns.forEach(function (btn) {
            btn.addEventListener("click", function () {
                backdrop.classList.add("d-none");
            });
        });

        backdrop.addEventListener("click", function (e) {
            if (e.target === backdrop) {
                backdrop.classList.add("d-none");
            }
        });
    }
})();
</script>
{% endblock %}
