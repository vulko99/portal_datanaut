{% extends "portal/base_portal.html" %}

{% block title_suffix %} · Usage{% endblock %}

{% block content %}
<div class="row g-3">
    <!-- ROW 1: OVERVIEW + KPIs -->
    <div class="col-12">
        <div class="portal-card">
            <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center">
                <div class="me-lg-4 mb-3 mb-lg-0">
                    <div class="section-eyebrow mb-1">Usage</div>
                    <h1 class="section-title mb-1">Licence usage overview</h1>
                    <p class="section-subtitle mb-0">
                        Real-time snapshot based on user–service assignments and login dates.
                        Highlights dormant usage, low-activity desks and overlapping products.
                    </p>
                </div>

                <div class="row g-3 flex-grow-1" style="max-width: 520px;">
                    <div class="col-6">
                        <div class="metric-label">Licences monitored</div>
                        <div class="metric-value">
                            {{ kpis.licences_monitored|default:"0" }}
                        </div>
                        <div class="portal-card-muted small">
                            Across {{ kpis.vendors_count|default:"0" }} vendors
                            and {{ kpis.desks_count|default:"0" }} desks.
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="metric-label">Potential savings</div>
                        <div class="metric-value">
                            {{ kpis.potential_savings|default:"0" }}
                        </div>
                        <div class="portal-card-muted small">
                            From low-usage &amp; dormant licences (illustrative).
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="metric-label">Healthy usage</div>
                        <div class="metric-value">
                            {{ kpis.healthy_percent|default:"0" }}%
                        </div>
                        <div class="portal-card-muted small">
                            Seats in the “healthy” band (last 90 days).
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="metric-label">Overlapping desks</div>
                        <div class="metric-value">
                            {{ kpis.overlapping_desks|default:"0" }}
                        </div>
                        <div class="portal-card-muted small">
                            Same or similar coverage delivered by multiple vendors.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ROW 2: MAIN GRID + SIDE CARDS -->
    <div class="col-12 col-xl-8">
    <div class="portal-card">
            <div class="section-eyebrow mb-1">Signals</div>
            <h5 class="section-title mb-1">Desks with potential optimisation</h5>
            <p class="portal-card-muted mb-3">
                Grid-style view of desks and usage signals, derived from cost centres,
                service assignments and login dates.
            </p>

            {% if desk_rows %}
                <!-- TOOLBAR: SEARCH + FILTER -->
                <div class="d-flex flex-wrap gap-2 align-items-center mb-3">
                    <div class="input-group input-group-sm" style="max-width: 320px;">
                        <span class="input-group-text text-uppercase fw-semibold" style="font-size: 0.7rem;">
                            Search
                        </span>
                        <input
                            type="search"
                            id="usageDeskSearch"
                            class="form-control"
                            placeholder="Desk, vendor, signal…">
                    </div>

                    <select id="usageSeverityFilter" class="form-select form-select-sm" style="max-width: 180px;">
                        <option value="">All severities</option>
                        <option value="high">High impact</option>
                        <option value="medium">Medium</option>
                        <option value="low">Low / healthy</option>
                    </select>

                    <div class="ms-auto d-flex align-items-center gap-3 small">
                        <div class="portal-card-muted">
                            Showing top
                            <span class="fw-semibold">20</span>
                            of {{ desk_rows|length }} desks by impact.
                        </div>
                        <a href="{% url 'portal:usage' %}?export=csv"
   class="btn btn-ghost btn-sm">
    Export CSV
</a>
                    </div>
                </div>

                <!-- MAIN TABLE (SCROLLABLE) -->
                <div class="table-responsive flex-grow-1" style="max-height: 460px; overflow-y: auto;">
                    <table class="portal-table align-middle">
                        <thead>
                            <tr>
                                <th style="width: 24%;">Desk / team</th>
                                <th style="width: 18%;">Vendor</th>
                                <th style="width: 10%;">Licences</th>
                                <th style="width: 24%;">Usage signal</th>
                                <th style="width: 14%;">Last 90 days</th>
                                <th style="width: 10%;">Impact</th>
                            </tr>
                        </thead>
                        <tbody id="usageDesksTableBody">
                            {% for row in desk_rows|slice:":20" %}
                                <tr
                                    data-desk="{{ row.desk_label }}"
                                    data-vendor="{{ row.vendor_label }}"
                                    data-severity="{{ row.severity }}"
                                >
                                    <td><strong>{{ row.desk_label }}</strong></td>
                                    <td class="cell-muted">{{ row.vendor_label }}</td>
                                    <td class="cell-muted">{{ row.licences }}</td>
                                    <td class="cell-muted">{{ row.usage_signal }}</td>
                                    <td class="cell-muted">{{ row.last_90_days }}</td>
                                    <td>
                                        {% if row.severity == "high" %}
                                            <span class="badge bg-danger-subtle text-danger">High impact</span>
                                        {% elif row.severity == "medium" %}
                                            <span class="badge bg-warning-subtle text-warning">Medium</span>
                                        {% else %}
                                            <span class="badge bg-success-subtle text-success">Healthy</span>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <p class="portal-card-muted mb-0 mt-2">
                    In a full deployment this table can be drilled down to individual users,
                    specific services and underlying contract data.
                </p>
            {% else %}
                <div class="empty">
                    No usage data yet. Assign services to users and refresh this view to see
                    desks and optimisation signals.
                </div>
            {% endif %}
        </div>
    </div>

    <!-- SIDE CARDS -->
    <div class="col-12 col-xl-4">
        {# --- Dormant licences --- #}
        <div class="portal-card mb-3">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                    <div class="section-eyebrow mb-1">Dormant licences</div>
                    <h5 class="section-title mb-1">Users with no recent activity</h5>
                    <p class="portal-card-muted mb-0">
                        Users with &gt;60 days without any login on at least one assigned
                        service. Candidates for decommissioning or licence recycling.
                    </p>
                </div>
                <div class="text-end ms-3">
                    <div class="metric-label small text-uppercase">Dormant users</div>
                    <div class="metric-value" style="font-size: 1.1rem;">
                        {{ dormant_users|length }}
                    </div>
                </div>
            </div>

            <div class="table-responsive">
                <table class="portal-table align-middle">
                    <thead>
                    <tr>
                        <th style="width: 28%;">User</th>
                        <th style="width: 32%;">Desk</th>
                        <th style="width: 20%;">Vendor</th>
                        <th style="width: 20%;">Last login</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% if dormant_users %}
                        {% for u in dormant_users|slice:":5" %}
                            <tr>
                                <td class="cell-muted">{{ u.username }}</td>
                                <td class="cell-muted">{{ u.desk_label }}</td>
                                <td class="cell-muted">{{ u.vendor }}</td>
                                <td class="cell-muted">
                                    {% if u.days_since_login %}
                                        {{ u.days_since_login }} days
                                    {% else %}
                                        No login
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="4" class="cell-muted text-center small py-3">
                                No dormant users in the last 60 days.
                            </td>
                        </tr>
                    {% endif %}
                    </tbody>
                </table>
            </div>

            <div class="d-flex justify-content-between align-items-center mt-2 small portal-card-muted">
                <span>Review full user list and access.</span>
                <a href="{% url 'portal:usage_users' %}" class="link-inline">
                    Open user inventory &rarr;
                </a>
            </div>
        </div>

        {# --- Overlapping products --- #}
        <div class="portal-card">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                    <div class="section-eyebrow mb-1">Overlapping products</div>
                    <h5 class="section-title mb-1">Desks with duplicate coverage</h5>
                    <p class="portal-card-muted mb-0">
                        Cases where the same data set or functionality is supplied by
                        multiple vendors for the same desk.
                    </p>
                </div>
                <div class="text-end ms-3">
                    <div class="metric-label small text-uppercase">Overlapping desks</div>
                    <div class="metric-value" style="font-size: 1.1rem;">
                        {{ kpis.overlapping_desks }}
                    </div>
                </div>
            </div>

            <div class="table-responsive">
                <table class="portal-table align-middle">
                    <thead>
                    <tr>
                        <th style="width: 32%;">Desk</th>
                        <th style="width: 30%;">Vendors</th>
                        <th style="width: 38%;">Opportunity</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% if overlapping_rows %}
                        {% for r in overlapping_rows|slice:":5" %}
                            <tr>
                                <td class="cell-muted">{{ r.desk_label }}</td>
                                <td class="cell-muted">{{ r.vendors_label }}</td>
                                <td class="cell-muted">{{ r.opportunity }}</td>
                            </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="3" class="cell-muted text-center small py-3">
                                No desks with overlapping vendor coverage detected.
                            </td>
                        </tr>
                    {% endif %}
                    </tbody>
                </table>
            </div>

            <div class="d-flex justify-content-between align-items-center mt-2 small portal-card-muted">
                <span>Drill into vendor and contract detail.</span>
                <a href="{% url 'portal:usage_vendors' %}" class="link-inline">
                    Open vendor inventory &rarr;
                </a>
            </div>
        </div>
    </div>

    <!-- ROW 3: SUMMARY / NEXT ACTIONS -->
    <div class="col-12 col-xl-6">
        <div class="portal-card">
            <div class="section-eyebrow mb-1">Summary</div>
            <h5 class="section-title mb-2">What this view is for</h5>
            <ul class="portal-card-muted mb-0">
                <li class="mb-2">
                    Gives Trading, Market Data and Finance a single view of where licences are
                    under-used or dormant.
                </li>
                <li class="mb-2">
                    Highlights desks with overlapping vendor coverage ahead of contract renewals.
                </li>
                <li class="mb-2">
                    Connects usage signals directly into contract and invoice data in the rest of the portal.
                </li>
            </ul>
        </div>
    </div>

    <div class="col-12 col-xl-6">
        <div class="portal-card">
            <div class="section-eyebrow mb-1">Next actions</div>
            <h5 class="section-title mb-2">How clients typically use this</h5>
            <ul class="portal-card-muted mb-0">
                <li class="mb-2">
                    Export a short usage pack per vendor to support commercial discussions.
                </li>
                <li class="mb-2">
                    Agree decommission / recycle plans per desk and track progress month-on-month.
                </li>
                <li class="mb-2">
                    Tie confirmed optimisation items back into cost centre allocation and budget planning.
                </li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function () {
    const searchInput = document.getElementById('usageDeskSearch');
    const severitySelect = document.getElementById('usageSeverityFilter');
    const tableBody = document.getElementById('usageDesksTableBody');

    if (!tableBody) return;

    const rows = Array.from(tableBody.querySelectorAll('tr'));

    function applyFilters() {
        const query = (searchInput ? searchInput.value : '').toLowerCase();
        const severity = severitySelect ? severitySelect.value : '';

        rows.forEach(row => {
            const desk = (row.dataset.desk || '').toLowerCase();
            const vendor = (row.dataset.vendor || '').toLowerCase();
            const fullText = (row.textContent || '').toLowerCase();
            const rowSeverity = (row.dataset.severity || '').toLowerCase();

            const matchesText =
                !query ||
                desk.includes(query) ||
                vendor.includes(query) ||
                fullText.includes(query);

            const matchesSeverity =
                !severity || rowSeverity === severity;

            row.style.display = (matchesText && matchesSeverity) ? '' : 'none';
        });
    }

    if (searchInput) searchInput.addEventListener('input', applyFilters);
    if (severitySelect) severitySelect.addEventListener('change', applyFilters);
})();
</script>
{% endblock %}
