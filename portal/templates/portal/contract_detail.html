{% extends "portal/base_portal.html" %}

{% block title_suffix %} · Contract · {{ contract.contract_name }}{% endblock %}

{% block content %}
<div class="row g-3">

    <!-- HEADER -->
    <div class="col-12">
        <div class="portal-card">
            <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
                <div>
                    <div class="section-eyebrow mb-1">Contracts · Detail</div>
                    <h1 class="section-title mb-1">{{ contract.contract_name }}</h1>
                    <p class="section-subtitle mb-0">
                        Vendor:
                        <a href="{% url 'portal:vendor_detail' contract.vendor.pk %}" class="link-inline">
                            {{ contract.vendor.name }}
                        </a>
                        {% if contract.contract_id %} · ID: {{ contract.contract_id }}{% endif %}
                        {% if contract.entity %} · Entity: {{ contract.entity }}{% endif %}
                    </p>
                </div>

                <div class="text-end">
                    <div class="metric-label mb-1">Status</div>
                    <div class="metric-value" style="font-size:1rem;">
                        {{ contract.status|default:"—" }}
                    </div>
                    <div class="portal-card-muted small mt-2">
                        Owner: {{ contract.owner.username }}
                    </div>

                    <div class="d-flex justify-content-end flex-wrap gap-2 mt-3">
                        <a href="{% url 'portal:contracts' %}" class="btn btn-ghost btn-sm">
                            Back to contracts
                        </a>

                        {% if contract.file %}
                            <a href="{{ contract.file.url }}" target="_blank" rel="noopener"
                               class="btn btn-ghost btn-sm">
                                Open contract document
                            </a>
                        {% endif %}

                        <button type="button" id="contract-cancel-btn"
                                class="btn btn-ghost btn-sm d-none">
                            Cancel
                        </button>

                        <button type="button" id="contract-edit-btn"
                                class="btn btn-add btn-sm">
                            Edit
                        </button>

                        <button type="button" id="contract-delete-open"
                                class="btn btn-ghost btn-sm">
                            Delete
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- LEFT: DETAILS – VIEW MODE -->
    <div class="col-lg-7" id="contract-view-mode">
        <div class="portal-card h-100">
            <h6 class="mb-2">Contract details</h6>
            <p class="portal-card-muted mb-3">
                Core terms and allocation information used for renewals, approvals and reporting.
            </p>

            <div class="row gy-3">
                <div class="col-sm-6">
                    <div class="metric-label mb-1">Vendor</div>
                    <div>{{ contract.vendor.name }}</div>
                </div>
                <div class="col-sm-6">
                    <div class="metric-label mb-1">Contract name</div>
                    <div>{{ contract.contract_name }}</div>
                </div>

                <div class="col-sm-6">
                    <div class="metric-label mb-1">Type</div>
                    <div>{{ contract.contract_type|default:"—" }}</div>
                </div>
                <div class="col-sm-6">
                    <div class="metric-label mb-1">Contract ID</div>
                    <div>{{ contract.contract_id|default:"—" }}</div>
                </div>

                <div class="col-sm-6">
                    <div class="metric-label mb-1">Entity</div>
                    <div>{{ contract.entity|default:"—" }}</div>
                </div>
                <div class="col-sm-6">
                    <div class="metric-label mb-1">Cost centre</div>
                    <div>
                        {% if contract.owning_cost_center %}
                            {{ contract.owning_cost_center.code }} – {{ contract.owning_cost_center.name }}
                        {% else %}
                            —
                        {% endif %}
                    </div>
                </div>

                <div class="col-sm-4">
                    <div class="metric-label mb-1">Start date</div>
                    <div>
                        {% if contract.start_date %}
                            {{ contract.start_date|date:"M. d, Y" }}
                        {% else %}—{% endif %}
                    </div>
                </div>
                <div class="col-sm-4">
                    <div class="metric-label mb-1">End date</div>
                    <div>
                        {% if contract.end_date %}
                            {{ contract.end_date|date:"M. d, Y" }}
                        {% else %}—{% endif %}
                    </div>
                </div>
                <div class="col-sm-4">
                    <div class="metric-label mb-1">Renewal date</div>
                    <div>
                        {% if contract.renewal_date %}
                            {{ contract.renewal_date|date:"M. d, Y" }}
                        {% else %}—{% endif %}
                    </div>
                </div>

                <div class="col-sm-6">
                    <div class="metric-label mb-1">Annual value</div>
                    <div>
                        {% if contract.annual_value %}
                            {{ contract.annual_value }} {{ contract.currency|default:"" }}
                        {% else %}
                            —
                        {% endif %}
                    </div>
                </div>
                <div class="col-sm-6">
                    <div class="metric-label mb-1">Currency</div>
                    <div>{{ contract.currency|default:"—" }}</div>
                </div>

                <div class="col-sm-6">
                    <div class="metric-label mb-1">Notice period (days)</div>
                    <div>{{ contract.notice_period_days|default:"—" }}</div>
                </div>
                <div class="col-sm-6">
                    <div class="metric-label mb-1">Notice date</div>
                    <div>
                        {% if contract.notice_date %}
                            {{ contract.notice_date|date:"M. d, Y" }}
                        {% else %}—{% endif %}
                    </div>
                </div>

                <div class="col-12">
                    <div class="metric-label mb-1">Notes</div>
                    <div>{{ contract.notes|default:"—" }}</div>
                </div>

                <div class="col-12">
                    <div class="metric-label mb-1">Created / updated</div>
                    <div>
                        {{ contract.created_at|date:"Y-m-d" }} · {{ contract.updated_at|date:"Y-m-d" }}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- LEFT: DETAILS – EDIT MODE -->
    <div class="col-lg-7 d-none" id="contract-edit-mode">
        <form method="post">
            {% csrf_token %}
            <input type="hidden" name="action" value="update">
            <div class="portal-card h-100">
                <h6 class="mb-2">Contract details</h6>
                <p class="portal-card-muted mb-3">
                    Update the core terms for this contract. Use Save changes to apply.
                </p>

                <div class="row g-3 small">
                    <div class="col-md-6">
                        <label class="form-label form-label-sm">Vendor</label>
                        <select name="vendor_id" class="form-select form-select-sm">
                            <option value="">---------</option>
                            {% for v in vendors %}
                                <option value="{{ v.pk }}" {% if v.pk == contract.vendor_id %}selected{% endif %}>
                                    {{ v.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label form-label-sm">Contract name</label>
                        <input type="text" name="contract_name" class="form-control form-control-sm"
                               value="{{ contract.contract_name }}">
                    </div>

                    <div class="col-md-6">
                        <label class="form-label form-label-sm">Type</label>
                        <input type="text" name="contract_type" class="form-control form-control-sm"
                               value="{{ contract.contract_type }}">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label form-label-sm">Contract ID</label>
                        <input type="text" name="contract_id" class="form-control form-control-sm"
                               value="{{ contract.contract_id }}">
                    </div>

                    <div class="col-md-6">
                        <label class="form-label form-label-sm">Entity</label>
                        <input type="text" name="entity" class="form-control form-control-sm"
                               value="{{ contract.entity }}">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label form-label-sm">Cost centre</label>
                        <select name="cost_center_id" class="form-select form-select-sm">
                            <option value="">---------</option>
                            {% for c in cost_centers %}
                                <option value="{{ c.pk }}" {% if contract.owning_cost_center_id == c.pk %}selected{% endif %}>
                                    {{ c.code }} – {{ c.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label form-label-sm">Start date</label>
                        <input type="date" name="start_date" class="form-control form-control-sm"
                               value="{{ contract.start_date|date:'Y-m-d' }}">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label form-label-sm">End date</label>
                        <input type="date" name="end_date" class="form-control form-control-sm"
                               value="{{ contract.end_date|date:'Y-m-d' }}">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label form-label-sm">Renewal date</label>
                        <input type="date" name="renewal_date" class="form-control form-control-sm"
                               value="{{ contract.renewal_date|date:'Y-m-d' }}">
                    </div>

                    <div class="col-md-6">
                        <label class="form-label form-label-sm">Annual value</label>
                        <input type="text" name="annual_value" class="form-control form-control-sm"
                               value="{{ contract.annual_value|default_if_none:'' }}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label form-label-sm">Currency</label>
                        <input type="text" name="currency" class="form-control form-control-sm"
                               value="{{ contract.currency }}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label form-label-sm">Status</label>
                        <input type="text" name="status" class="form-control form-control-sm"
                               value="{{ contract.status }}">
                    </div>

                    <div class="col-md-6">
                        <label class="form-label form-label-sm">Notice period (days)</label>
                        <select name="notice_period_days" class="form-select form-select-sm">
                            <option value="">---------</option>
                            <option value="30" {% if contract.notice_period_days == 30 %}selected{% endif %}>30 days</option>
                            <option value="60" {% if contract.notice_period_days == 60 %}selected{% endif %}>60 days</option>
                            <option value="90" {% if contract.notice_period_days == 90 %}selected{% endif %}>90 days</option>
                            <option value="120" {% if contract.notice_period_days == 120 %}selected{% endif %}>120 days</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label form-label-sm">Notice date</label>
                        <input type="date" name="notice_date" class="form-control form-control-sm"
                               value="{{ contract.notice_date|date:'Y-m-d' }}">
                    </div>

                    <div class="col-12">
                        <label class="form-label form-label-sm">Notes</label>
                        <textarea name="notes" rows="3" class="form-control form-control-sm">{{ contract.notes }}</textarea>
                    </div>
                </div>

                <div class="d-flex justify-content-end gap-2 mt-3">
                    <button type="submit" class="btn btn-add btn-sm">
                        Save changes
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- RIGHT: NOTICE SUMMARY + INVOICES LIST (VIEW ONLY) -->
    <div class="col-lg-5 d-flex flex-column gap-3">
        <div class="portal-card">
            <h6 class="mb-2">Notice / termination</h6>
            <div class="row gy-3">
                <div class="col-sm-6">
                    <div class="metric-label mb-1">Notice period</div>
                    <div>
                        {% if contract.notice_period_days %}
                            {{ contract.notice_period_days }} days
                        {% else %}
                            —
                        {% endif %}
                    </div>
                </div>
                <div class="col-sm-6">
                    <div class="metric-label mb-1">Notice date</div>
                    <div>
                        {% if contract.notice_date %}
                            {{ contract.notice_date|date:"M. d, Y" }}
                        {% else %}—{% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="portal-card">
            <h6 class="mb-2">Invoices under this contract</h6>
            {% if invoices %}
                <div class="table-responsive">
                    <table class="portal-table align-middle">
                        <thead>
                        <tr>
                            <th>Invoice</th>
                            <th>Date</th>
                            <th>Currency</th>
                            <th class="text-end">Total</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for inv in invoices %}
                            <tr>
                                <td class="cell-muted">
                                    <a href="{% url 'portal:invoice_detail' inv.pk %}" class="link-inline">
                                        {{ inv.invoice_number }}
                                    </a>
                                </td>
                                <td class="cell-muted">{{ inv.invoice_date|date:"M. d, Y" }}</td>
                                <td class="cell-muted">{{ inv.currency }}</td>
                                <td class="cell-muted text-end">{{ inv.total_amount }}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="portal-card-muted mb-0">No invoices under this contract yet.</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- DELETE MODAL -->
<div id="contract-delete-backdrop" class="portal-modal-backdrop d-none">
    <div class="portal-modal-card">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="mb-0">Delete contract</h6>
            <button type="button" class="btn btn-ghost btn-sm delete-contract-cancel" aria-label="Close">
                ✕
            </button>
        </div>
        <p class="mb-2">
            Are you sure you want to delete contract <strong>{{ contract.contract_name }}</strong>?
        </p>
        <p class="portal-card-muted mb-4">
            This action cannot be undone.
        </p>

        <form method="post" id="contract-delete-form">
            {% csrf_token %}
            <input type="hidden" name="action" value="delete">
            <div class="d-flex justify-content-end gap-2">
                <button type="button" class="btn btn-ghost btn-sm delete-contract-cancel">
                    Cancel
                </button>
                <button type="submit" class="btn btn-danger btn-sm">
                    Delete
                </button>
            </div>
        </form>
    </div>
</div>

<style>
/* Локален стил за модала – максимално близък до този при user */
.portal-modal-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(3, 6, 23, 0.85);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1100;
}

.portal-modal-card {
    background: #050816;
    border-radius: 12px;
    padding: 1.5rem 1.75rem;
    max-width: 520px;
    width: 100%;
    box-shadow: 0 24px 80px rgba(0, 0, 0, 0.65);
}
</style>

<script>
(function () {
    const viewMode = document.getElementById("contract-view-mode");
    const editMode = document.getElementById("contract-edit-mode");
    const editBtn = document.getElementById("contract-edit-btn");
    const cancelBtn = document.getElementById("contract-cancel-btn");

    if (editBtn && viewMode && editMode && cancelBtn) {
        editBtn.addEventListener("click", function () {
            viewMode.classList.add("d-none");
            editMode.classList.remove("d-none");
            editBtn.classList.add("d-none");
            cancelBtn.classList.remove("d-none");
        });

        cancelBtn.addEventListener("click", function () {
            window.location.reload();
        });
    }

    // Delete modal
    const openDeleteBtn = document.getElementById("contract-delete-open");
    const backdrop = document.getElementById("contract-delete-backdrop");
    const cancelDeleteBtns = document.querySelectorAll(".delete-contract-cancel");

    if (openDeleteBtn && backdrop) {
        openDeleteBtn.addEventListener("click", function () {
            backdrop.classList.remove("d-none");
        });

        cancelDeleteBtns.forEach(function (btn) {
            btn.addEventListener("click", function () {
                backdrop.classList.add("d-none");
            });
        });

        // Клик извън картата – затваря
        backdrop.addEventListener("click", function (e) {
            if (e.target === backdrop) {
                backdrop.classList.add("d-none");
            }
        });
    }
})();
</script>
{% endblock %}
