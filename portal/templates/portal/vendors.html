{% extends "portal/base_portal.html" %}

{% block title_suffix %} · Vendors{% endblock %}

{% block content %}
<div class="row g-3">
    <div class="col-12">
        <div class="portal-card">
            <div class="section-header mb-2">
                <div class="section-eyebrow">Inventory</div>
                <h1 class="section-title mb-0">Vendors</h1>
                <p class="section-subtitle mb-0">
                    Basic vendor inventory – market data, reference data, indexes, connectivity and other providers.
                    Click a vendor to see related contracts, invoices and services.
                </p>
            </div>

            <div class="d-flex flex-wrap align-items-center justify-content-between mt-1">
                <div class="d-flex flex-wrap gap-3">
                    <div>
                        <div class="metric-label">Total vendors</div>
                        <div class="metric-value">
                            {{ vendors|length }}
                        </div>
                    </div>
                </div>
                <div class="text-end small text-muted">
                    Vendors can be created from the portal.
                </div>
            </div>
        </div>
    </div>

    <div class="col-12">
        <div class="portal-card">
            <h6 class="mb-2">Vendor list</h6>
            <p class="portal-card-muted mb-3">
                Overview of all vendors in scope. Later this will power contract, invoice and license analytics.
            </p>

            {% if vendors %}
                <div class="table-responsive">
                    <table class="portal-table align-middle">
                        <thead>
                            <tr>
                                <th style="width: 24%;">Vendor</th>
                                <th style="width: 16%;">Type</th>
                                <th style="width: 10%;">Contracts</th>
                                <th style="width: 10%;">Invoices</th>
                                <th style="width: 20%;">Primary contact</th>
                                <th style="width: 20%;">Website</th>
                                <th style="width: 10%;">Tags</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for vendor in vendors %}
                                <tr>
                                    <td>
                                        <a href="{% url 'portal:vendor_detail' vendor.pk %}"
                                           class="link-inline">
                                            {{ vendor.name }}
                                        </a>
                                    </td>
                                    <td class="cell-muted">
                                        {{ vendor.get_vendor_type_display|default:"—" }}
                                    </td>
                                    <td class="cell-muted">
                                        {{ vendor.contract_count|default:"0" }}
                                    </td>
                                    <td class="cell-muted">
                                        {{ vendor.invoice_count|default:"0" }}
                                    </td>
                                    <td class="cell-muted">
                                        {% if vendor.primary_contact_name or vendor.primary_contact_email %}
                                            {{ vendor.primary_contact_name|default_if_none:"" }}
                                            {% if vendor.primary_contact_email %}
                                                <br>
                                                <a href="mailto:{{ vendor.primary_contact_email }}" class="link-inline">
                                                    {{ vendor.primary_contact_email }}
                                                </a>
                                            {% endif %}
                                        {% else %}
                                            —
                                        {% endif %}
                                    </td>
                                    <td class="cell-muted">
                                        {% if vendor.website %}
                                            <a href="{{ vendor.website }}" target="_blank"
                                               rel="noopener" class="link-inline">
                                                {{ vendor.website }}
                                            </a>
                                        {% else %}
                                            —
                                        {% endif %}
                                    </td>
                                    <td class="cell-muted">
                                        {{ vendor.tags|default:"—" }}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="portal-card-muted mb-0">
                    No vendors yet. Use the + Add button to create the first one.
                </p>
            {% endif %}
        </div>
    </div>
</div>

{# --------- ADD VENDOR MODAL --------- #}
<div class="modal fade" id="addVendorModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content" style="background: rgba(10,15,25,.96); color:#E5E7EB; border-radius:18px; border:1px solid rgba(148,163,184,.4);">
            <div class="modal-header border-0 pt-3 pb-1 px-4">
                <div>
                    <h5 class="modal-title">Add new vendor</h5>
                    <div class="small text-muted">
                        Create a new vendor in the inventory.
                    </div>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body px-4 pb-4">
                <form method="post">
                    {% csrf_token %}

                    {{ form.non_field_errors }}

                    <div class="row g-3 mb-3">
                        <div class="col-md-6 col-xl-4">
                            <label class="form-label">Vendor name</label>
                            {{ form.name }}
                            {{ form.name.errors }}
                        </div>
                        <div class="col-md-6 col-xl-4">
                            <label class="form-label">Type</label>
                            {{ form.vendor_type }}
                            {{ form.vendor_type.errors }}
                        </div>
                        <div class="col-md-12 col-xl-4">
                            <label class="form-label">Tags</label>
                            {{ form.tags }}
                            {{ form.tags.errors }}
                        </div>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Primary contact name</label>
                            {{ form.primary_contact_name }}
                            {{ form.primary_contact_name.errors }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Primary contact email</label>
                            {{ form.primary_contact_email }}
                            {{ form.primary_contact_email.errors }}
                        </div>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Website</label>
                            {{ form.website }}
                            {{ form.website.errors }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Internal notes</label>
                            {{ form.notes }}
                            {{ form.notes.errors }}
                        </div>
                    </div>

                    <div class="d-flex justify-content-end gap-2">
                        <button type="button" class="btn btn-ghost btn-sm" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-add btn-sm">
                            Save and close
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener("DOMContentLoaded", function () {
    // Ако има грешки във формата след POST, отваряме модала автоматично
    const hasErrors =
        document.querySelector("#addVendorModal .errorlist") !== null;

    if (hasErrors) {
        const modalEl = document.getElementById("addVendorModal");
        if (modalEl && window.bootstrap) {
            const modal = new bootstrap.Modal(modalEl);
            modal.show();
        }
    }
});
</script>
{% endblock %}
