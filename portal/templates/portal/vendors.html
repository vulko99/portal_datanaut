{% extends "portal/base_portal.html" %}

{% block title_suffix %} · Vendors{% endblock %}

{% block content %}
<div class="row g-3">
    <div class="col-12">
        <div class="portal-card">
            <div class="section-header mb-2">
                <div class="section-eyebrow">Inventory</div>
                <h1 class="section-title mb-0">Vendors</h1>
                <p class="section-subtitle mb-0">
                    Your vendor catalogue with contact details, contracts and services.
                </p>
            </div>

            <div class="d-flex flex-wrap align-items-center justify-content-between mt-1 mb-2">
                <div class="d-flex flex-wrap gap-3 align-items-end">
                    <div>
                        <div class="metric-label">Total vendors</div>
                        <div class="metric-value">
                            {{ vendors|length }}
                        </div>
                    </div>

                    {# Show Closed toggle (drives ?show_closed=1) #}
                    <form method="get" class="d-flex align-items-center gap-2 small" style="margin-bottom: .15rem;">
                        <div class="form-check form-switch m-0">
                            <input class="form-check-input"
                                   type="checkbox"
                                   id="show-closed-toggle"
                                   name="show_closed"
                                   value="1"
                                   {% if request.GET.show_closed %}checked{% endif %}
                                   onchange="this.form.submit()">
                            <label class="form-check-label" for="show-closed-toggle">
                                Show Closed
                            </label>
                        </div>

                        {# keep other GET params here later (e.g. search/type), if you add them #}
                        {# example:
                        <input type="hidden" name="q" value="{{ request.GET.q }}">
                        #}
                    </form>
                </div>

                <div class="text-end small portal-card-muted">
                    Use the <strong>Add</strong> button in the top bar to register a new vendor.
                </div>
            </div>

            {% if vendors %}
                <div class="table-responsive">
                    <table class="portal-table align-middle">
                        <thead>
                        <tr>
                            <th style="width: 26%;">Vendor</th>
                            <th style="width: 16%;">Type</th>
                            <th style="width: 20%;">Tags</th>
                            <th style="width: 10%;">Contracts</th>
                            <th style="width: 10%;">Invoices</th>
                            <th style="width: 18%;">Website</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for vendor in vendors %}
                            <tr>
                                <td>
                                    <a href="{% url 'portal:vendor_detail' vendor.pk %}" class="link-inline">
                                        {{ vendor.name }}
                                    </a>
 
                                    {% if vendor.is_active == False %}
                                        <span class="badge rounded-pill bg-secondary ms-2">Closed</span>
                                    {% endif %}
                                </td>

                                <td class="cell-muted">
                                    {{ vendor.vendor_type|default:"—" }}
                                </td>

                                <td class="cell-muted">
                                    {{ vendor.tags|default:"—" }}
                                </td>

                                <td class="cell-muted">
                                    {{ vendor.contract_count|default:0 }}
                                </td>

                                <td class="cell-muted">
                                    {{ vendor.invoice_count|default:0 }}
                                </td>

                                <td class="cell-muted">
                                    {% if vendor.website %}
                                        <a href="{{ vendor.website }}" target="_blank" rel="noopener" class="link-inline">
                                            {{ vendor.website }}
                                        </a>
                                    {% else %}
                                        —
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="empty d-flex flex-wrap align-items-center justify-content-between">
                    <div>
                        No vendors yet. Add vendors to start linking contracts, invoices and services.
                    </div>
                    <div class="mt-2 mt-sm-0">
                        <button type="button"
                                class="btn btn-add btn-sm"
                                data-bs-toggle="modal"
                                data-bs-target="#addVendorModal">
                            + Add vendor
                        </button>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

{# --------- ADD VENDOR MODAL --------- #}
<div class="modal fade" id="addVendorModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content"
             style="background: rgba(10,15,25,.96); color:#E5E7EB; border-radius:18px; border:1px solid rgba(148,163,184,.4);">
            <div class="modal-header border-0 pt-3 pb-1 px-4">
                <div>
                    <h5 class="modal-title">Add new vendor</h5>
                    <div class="small text-muted">
                        Create a new vendor in the inventory.
                    </div>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
            </div>

            <div class="modal-body px-4 pb-4">
                <form method="post">
                    {% csrf_token %}

                    {{ form.non_field_errors }}

                    <div class="row g-3 mb-3 small">
                        <div class="col-md-6 col-xl-4">
                            <label class="form-label form-label-sm">Vendor name</label>
                            {{ form.name }}
                            {{ form.name.errors }}
                        </div>
                        <div class="col-md-6 col-xl-4">
                            <label class="form-label form-label-sm">Type</label>
                            {{ form.vendor_type }}
                            {{ form.vendor_type.errors }}
                        </div>
                        <div class="col-md-12 col-xl-4">
                            <label class="form-label form-label-sm">Tags</label>
                            {{ form.tags }}
                            {{ form.tags.errors }}
                        </div>
                    </div>

                    <div class="row g-3 mb-3 small">
                        <div class="col-md-6">
                            <label class="form-label form-label-sm">Primary contact name</label>
                            {{ form.primary_contact_name }}
                            {{ form.primary_contact_name.errors }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label form-label-sm">Primary contact email</label>
                            {{ form.primary_contact_email }}
                            {{ form.primary_contact_email.errors }}
                        </div>
                    </div>

                    <div class="row g-3 mb-4 small">
                        <div class="col-md-6">
                            <label class="form-label form-label-sm">Website</label>
                            {{ form.website }}
                            {{ form.website.errors }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label form-label-sm">Internal notes</label>
                            {{ form.notes }}
                            {{ form.notes.errors }}
                        </div>
                    </div>

                    <div class="d-flex justify-content-end gap-2">
                        <button type="button" class="btn btn-ghost btn-sm" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-add btn-sm">
                            Save and close
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener("DOMContentLoaded", function () {
    // If there are form errors after POST, auto-open the modal
    const hasErrors = document.querySelector("#addVendorModal .errorlist") !== null;

    if (hasErrors) {
        const modalEl = document.getElementById("addVendorModal");
        if (modalEl && window.bootstrap) {
            const modal = new bootstrap.Modal(modalEl);
            modal.show();
        }
    }
});
</script>
{% endblock %}
