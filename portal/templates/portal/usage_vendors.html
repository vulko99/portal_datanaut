{% extends "portal/base_portal.html" %}
{% load humanize %}

{% block title_suffix %} · Usage – Vendor inventory{% endblock %}

{% block content %}
<div class="mb-3">
  <ul class="nav nav-pills nav-sm bg-dark rounded-pill px-1 py-1 d-inline-flex shadow-sm">
    <li class="nav-item">
      <a class="nav-link text-white-50 px-3"
         href="{% url 'portal:usage_invoices' %}">
        Invoice inventory
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link text-white-50 px-3"
         href="{% url 'portal:usage_contract' %}">
        Contract inventory
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link active px-3" aria-current="page"
         href="{% url 'portal:usage_vendors' %}">
        Vendor inventory
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link text-white-50 px-3"
         href="{% url 'portal:usage_users' %}">
        User inventory
      </a>
    </li>
  </ul>
</div>

<div class="portal-card">
  <div class="section-eyebrow mb-1">Dashboards · Vendors</div>
  <h1 class="section-title mb-1">Vendor inventory</h1>
  <p class="section-subtitle mb-3">
    Summary of all vendors with active licences, based on actual ServiceAssignment data.
  </p>

  {# KPI ред + филтри + Export, всичко в един ред #}
  <div class="d-flex flex-wrap gap-3 mb-3 justify-content-between align-items-end">

    <div class="d-flex flex-wrap gap-3">
      <div class="portal-kpi">
        <div class="kpi-label text-muted small">Vendors</div>
        <div class="kpi-value h4 mb-0">
          {{ kpis.vendors_count|default:vendor_rows|length }}
        </div>
      </div>

      <div class="portal-kpi">
        <div class="kpi-label text-muted small">Licences monitored</div>
        <div class="kpi-value h4 mb-0">
          {{ kpis.licences_monitored|default:"0" }}
        </div>
      </div>

      <div class="portal-kpi">
        <div class="kpi-label text-muted small">Value at risk (dormant)</div>
        <div class="kpi-value h4 mb-0">
          {{ kpis.potential_savings|floatformat:2|intcomma }}
        </div>
      </div>
    </div>

    <div class="d-flex flex-wrap gap-2 align-items-end">
      <form method="get" class="d-flex align-items-center gap-2 mb-0">
        <label class="d-flex align-items-center gap-1 small text-muted mb-0">
          <input type="checkbox"
                 name="show_closed"
                 value="1"
                 {% if show_closed %}checked{% endif %}
                 onchange="this.form.submit()">
          <span>Show inactive vendors</span>
        </label>
      </form>

      <a href="?{% if show_closed %}show_closed=1&{% endif %}export=csv"
         class="btn btn-sm btn-outline-light">
        Export CSV
      </a>

      <div class="usage-search">
        <input id="vendor-search"
               type="text"
               class="form-control form-control-sm"
               autocomplete="off"
               placeholder="Search vendor…">
      </div>
    </div>
  </div>

  {# вътрешен скрол само за таблицата #}
  <div class="table-responsive" style="max-height: 540px; overflow-y: auto;">
    <table class="portal-table align-middle">
      <thead>
        <tr>
          <th>Vendor</th>
          <th class="text-end">Desks</th>
          <th class="text-end">Total licences</th>
          <th class="text-end">Active</th>
          <th class="text-end">Dormant</th>
          <th class="text-end">Annual value</th>
          <th class="text-end">Value at risk</th>
        </tr>
      </thead>
      <tbody id="vendor-table-body">
        {% for row in vendor_rows %}
          <tr>
            <td class="usage-cell-main">
              {{ row.vendor_name }}
            </td>
            <td class="text-end">{{ row.desks_count }}</td>
            <td class="text-end">{{ row.licences }}</td>
            <td class="text-end">{{ row.active_licences }}</td>
            <td class="text-end">
              {% if row.dormant_licences %}
                <span class="badge badge--warn">
                  {{ row.dormant_licences }}
                </span>
              {% else %}
                <span class="badge badge--ok">0</span>
              {% endif %}
            </td>
            <td class="text-end">
              {{ row.total_price|floatformat:2|intcomma }}
            </td>
            <td class="text-end">
              {% if row.dormant_price %}
                <span class="badge badge--accent">
                  {{ row.dormant_price|floatformat:2|intcomma }}
                </span>
              {% else %}
                —
              {% endif %}
            </td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="7" class="cell-muted text-center">
              No vendors found.
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="row mt-4 g-3">
    <div class="col-lg-6">
      <h2 class="h6 text-white mb-2">What this view is for</h2>
      <ul class="section-subtitle mb-0">
        <li>Show the full vendor landscape with licence volumes and spend per provider.</li>
        <li>Quickly identify where dormant licences and overlapping coverage sit.</li>
        <li>Connect vendor economics back to desk-level usage and contracts.</li>
      </ul>
    </div>
    <div class="col-lg-6">
      <h2 class="h6 text-white mb-2">How clients typically use this</h2>
      <ul class="section-subtitle mb-0">
        <li>Prioritise vendors for optimisation or RFP based on value at risk.</li>
        <li>Prepare vendor review packs with a clean CSV export per provider.</li>
        <li>Benchmark vendors against each other by footprint and desk coverage.</li>
      </ul>
    </div>
  </div>
</div>

<script>
  (function () {
    const input = document.getElementById('vendor-search');
    if (!input) return;
    const rows = document.querySelectorAll('#vendor-table-body tr');

    input.addEventListener('input', function () {
      const q = this.value.toLowerCase();
      rows.forEach(function (tr) {
        const vendorCell = tr.querySelector('td');
        if (!vendorCell) return;
        const text = vendorCell.textContent.toLowerCase();
        tr.style.display = (!q || text.indexOf(q) !== -1) ? '' : 'none';
      });
    });
  })();
</script>
{% endblock %}
