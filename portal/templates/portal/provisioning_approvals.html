{% extends "portal/base_provisioning.html" %}

{% block content %}

<div class="portal-card">
  <div class="d-flex align-items-start justify-content-between gap-3">
    <div>
      <div class="section-eyebrow">Provisioning Hub</div>
      <div class="section-title">Approvals</div>
      <div class="section-subtitle">
        Requests waiting for your decision. Approve or reject in bulk.
      </div>
    </div>
    <a href="{% url 'portal:provisioning_hub' %}" class="btn btn-ghost btn-sm">Back</a>
  </div>

  <div class="mt-3">
    {% if approvals %}
      <form id="approvalsForm" method="post" action="{% url 'portal:provisioning_approvals_decide_bulk' %}">
        {% csrf_token %}

        {# скрити полета – JS ще ги попълни от модала #}
        <input type="hidden" name="decision" id="decisionField">
        <input type="hidden" name="decision_note" id="decisionNoteField">

        <div class="d-flex justify-content-between align-items-center mb-2 gap-2 flex-wrap">
          <div class="d-flex align-items-center gap-2 flex-wrap">
            <div class="dn-pill">
              Pending: <strong class="ms-1">{{ approvals|length }}</strong>
            </div>
            <div class="dn-pill">
              Selected: <span id="selCount" class="ms-1">0</span>
            </div>
          </div>

          <div class="d-flex flex-wrap gap-2 align-items-center justify-content-end flex-grow-1">
            <div class="d-flex gap-2">
              <button id="btnApproveOpen"
                      class="btn btn-add btn-sm"
                      type="button"
                      disabled>
                Approve selected
              </button>
              <button id="btnRejectOpen"
                      class="btn btn-ghost btn-sm"
                      type="button"
                      disabled>
                Reject selected
              </button>
            </div>
          </div>
        </div>

        <div class="table-responsive" style="max-height: 460px; overflow-y:auto;">
          <table class="portal-table align-middle mb-0">
            <thead>
              <tr>
                <th style="width:44px;">
                  <input class="form-check-input" type="checkbox" id="chkAll">
                </th>
                <th style="width:80px;">ID</th>
                <th style="width:18%;">Requester</th>
                <th>Service</th>
                <th style="width:24%;">Reason</th>
                <th style="width:160px;" class="text-end">Created</th>
              </tr>
            </thead>
            <tbody>
              {% for r in approvals %}
                <tr>
                  <td>
                    <input
                      class="form-check-input chkRow"
                      type="checkbox"
                      name="ids"
                      value="{{ r.id }}"
                      data-id="{{ r.id }}"
                    >
                  </td>

                  <td class="cell-muted">#{{ r.id }}</td>

                  <td>
                    {{ r.requester.profile.full_name|default:r.requester.username }}
                  </td>

                  <td>
                    {% if r.service %}
                      <div>{{ r.service.name }}</div>
                      <div class="small text-muted">
                        {% if r.service.vendor %}
                          {{ r.service.vendor.name }}
                        {% endif %}
                      </div>
                    {% else %}
                      —
                    {% endif %}
                  </td>

                  <td class="cell-muted small">
                    {{ r.reason|default:"—" }}
                  </td>

                  <td class="cell-muted text-end">
                    {% if r.created_at %}
                      {{ r.created_at|date:"Y-m-d H:i" }}
                    {% else %}
                      —
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="table-caption">
          Tip: Use “Select all”, then approve or reject multiple requests in one action.
          The decision note (optional) will be saved for all selected requests.
        </div>
      </form>

      {# MODAL за decision note #}
      <div class="modal fade" id="decisionModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" style="max-width: 520px;">
          <div class="modal-content portal-modal p-0" style="overflow:hidden;">

            <div class="px-4 pt-4 pb-3" style="border-bottom:1px solid rgba(148,163,184,.18);">
              <div class="d-flex justify-content-between align-items-start gap-3">
                <div>
                  <div class="section-eyebrow">Provisioning Hub</div>
                  <div id="decisionModalTitle"
                       class="section-title"
                       style="font-size:1.15rem; margin:0;">
                    Decide on requests
                  </div>
                  <div class="portal-card-muted" style="margin-top:6px; font-size:.9rem;">
                    Optional: add a decision note that will be stored on all selected requests.
                  </div>
                </div>

                <button type="button"
                        class="btn btn-ghost btn-sm"
                        data-bs-dismiss="modal"
                        aria-label="Close"
                        style="border-radius: 10px; width:36px; height:36px; padding:0; display:flex; align-items:center; justify-content:center;">
                  <span aria-hidden="true" style="font-size:1.05rem; line-height:1;">×</span>
                </button>
              </div>
            </div>

            <div class="px-4 py-3">
              <label for="decisionNoteTextarea"
                     class="form-label small text-muted mb-1">
                Decision note (optional)
              </label>
              <textarea id="decisionNoteTextarea"
                        rows="3"
                        class="form-control form-control-sm bg-white text-dark"
                        placeholder="Short explanation of the decision, visible to the requester."></textarea>
              <div class="form-text text-muted small">
                The same note will be attached to all selected requests.
              </div>
            </div>

            <div class="px-4 py-3 d-flex justify-content-end gap-2"
                 style="border-top:1px solid rgba(148,163,184,.18); background:rgba(2,6,23,.25);">
              <button type="button" class="btn btn-ghost btn-sm" data-bs-dismiss="modal">
                Cancel
              </button>
              <button type="button"
                      id="decisionConfirmBtn"
                      class="btn-add btn-sm">
                Confirm
              </button>
            </div>

          </div>
        </div>
      </div>

    {% else %}
      <div class="empty mt-3">
        No pending approvals.
      </div>
    {% endif %}
  </div>
</div>

{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
(function(){
  const chkAll = document.getElementById("chkAll");
  const rows = Array.from(document.querySelectorAll(".chkRow"));
  const selCount = document.getElementById("selCount");
  const btnApproveOpen = document.getElementById("btnApproveOpen");
  const btnRejectOpen = document.getElementById("btnRejectOpen");

  const form = document.getElementById("approvalsForm");
  const decisionField = document.getElementById("decisionField");
  const decisionNoteField = document.getElementById("decisionNoteField");

  const modalEl = document.getElementById("decisionModal");
  let bsModal = null;
  if (modalEl && window.bootstrap && bootstrap.Modal){
    bsModal = new bootstrap.Modal(modalEl);
  }
  const modalTitle = document.getElementById("decisionModalTitle");
  const noteTextarea = document.getElementById("decisionNoteTextarea");
  const confirmBtn = document.getElementById("decisionConfirmBtn");

  let currentDecision = null;  // "approve" или "reject"

  function refresh(){
    const c = rows.filter(r => r.checked).length;
    if (selCount) selCount.textContent = String(c);
    const enabled = c > 0;
    if (btnApproveOpen) btnApproveOpen.disabled = !enabled;
    if (btnRejectOpen) btnRejectOpen.disabled = !enabled;

    if (chkAll){
      if (c === 0) {
        chkAll.checked = false;
        chkAll.indeterminate = false;
      } else if (c === rows.length) {
        chkAll.checked = true;
        chkAll.indeterminate = false;
      } else {
        chkAll.checked = false;
        chkAll.indeterminate = true;
      }
    }
  }

  if (chkAll){
    chkAll.addEventListener("change", function(){
      rows.forEach(r => { r.checked = chkAll.checked; });
      refresh();
    });
  }
  rows.forEach(r => r.addEventListener("change", refresh));

  // отваряне на модала
  if (btnApproveOpen){
    btnApproveOpen.addEventListener("click", function(){
      if (!bsModal) return;
      currentDecision = "approve";
      if (modalTitle) modalTitle.textContent = "Approve selected requests";
      if (confirmBtn) confirmBtn.textContent = "Approve";
      if (noteTextarea) noteTextarea.value = "";
      bsModal.show();
    });
  }
  if (btnRejectOpen){
    btnRejectOpen.addEventListener("click", function(){
      if (!bsModal) return;
      currentDecision = "reject";
      if (modalTitle) modalTitle.textContent = "Reject selected requests";
      if (confirmBtn) confirmBtn.textContent = "Reject";
      if (noteTextarea) noteTextarea.value = "";
      bsModal.show();
    });
  }

  // потвърждение от модала -> попълваме hidden полетата и submit-ваме формата
  if (confirmBtn){
    confirmBtn.addEventListener("click", function(){
      if (!currentDecision || !form || !decisionField || !decisionNoteField) return;

      decisionField.value = currentDecision;
      decisionNoteField.value = noteTextarea ? noteTextarea.value.trim() : "";
      form.submit();
    });
  }

  // initial
  refresh();
})();
</script>
{% endblock %}
