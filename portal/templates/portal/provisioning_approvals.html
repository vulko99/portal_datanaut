{% extends "portal/base_portal.html" %}
{% block content %}

<div class="portal-card">
  <div class="d-flex align-items-start justify-content-between gap-3">
    <div>
      <div class="section-eyebrow">Provisioning Hub</div>
      <div class="section-title">Approvals</div>
      <div class="section-subtitle">Admin queue for approvals.</div>
    </div>
    <a href="{% url 'portal:provisioning_hub' %}" class="btn btn-ghost btn-sm">Back</a>
  </div>

  <div class="mt-3">
    {% if approvals %}
      <form method="post" action="{% url 'portal:provisioning_approvals_decide_bulk' %}">
        {% csrf_token %}

        <div class="d-flex justify-content-between align-items-center mb-2 gap-2 flex-wrap">
          <div class="dn-pill">
            Selected: <span id="selCount" class="ms-1">0</span>
          </div>

          <div class="d-flex gap-2">
            <button id="btnApprove" class="btn btn-add btn-sm" type="submit" name="decision" value="approve" disabled>
              Approve selected
            </button>
            <button id="btnReject" class="btn btn-ghost btn-sm" type="submit" name="decision" value="reject" disabled>
              Reject selected
            </button>
          </div>
        </div>

        <div class="table-responsive">
          <table class="portal-table align-middle">
            <thead>
              <tr>
                <th style="width:44px;">
                  <input class="form-check-input" type="checkbox" id="chkAll">
                </th>
                <th style="width:90px;">ID</th>
                <th>Requester</th>
                <th>Service</th>
                <th style="width:160px;" class="text-end">Created</th>
              </tr>
            </thead>
            <tbody>
              {% for r in approvals %}
                <tr>
                  <td>
                    <input
                      class="form-check-input chkRow"
                      type="checkbox"
                      name="ids"
                      value="{{ r.id }}"
                      data-id="{{ r.id }}"
                    >
                  </td>
                  <td class="cell-muted">{{ r.id }}</td>
                  <td>{{ r.requester.profile.full_name|default:r.requester.username }}</td>
                  <td>
                    {{ r.service.vendor.name }} — {{ r.service.name }}
                  </td>
                  <td class="cell-muted text-end">
                    {{ r.created_at|date:"Y-m-d H:i" }}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="table-caption">
          Tip: Use “Select all”, then approve or reject in one action.
        </div>
      </form>

      <script>
        (function(){
          const chkAll = document.getElementById("chkAll");
          const rows = Array.from(document.querySelectorAll(".chkRow"));
          const selCount = document.getElementById("selCount");
          const btnApprove = document.getElementById("btnApprove");
          const btnReject = document.getElementById("btnReject");

          function refresh(){
            const c = rows.filter(r => r.checked).length;
            selCount.textContent = String(c);
            const enabled = c > 0;
            btnApprove.disabled = !enabled;
            btnReject.disabled = !enabled;

            // sync "select all"
            if (c === 0) chkAll.checked = false;
            else if (c === rows.length) chkAll.checked = true;
            else chkAll.checked = false;
          }

          chkAll.addEventListener("change", function(){
            rows.forEach(r => r.checked = chkAll.checked);
            refresh();
          });

          rows.forEach(r => r.addEventListener("change", refresh));

          // initial
          refresh();
        })();
      </script>

    {% else %}
      <div class="empty mt-3">
        No pending approvals.
      </div>
    {% endif %}
  </div>
</div>

{% endblock %}
